<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loansphere - Borrower Management</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="./Loansphere_Borrower.css" rel="stylesheet">
</head>

<body>
    <div id="loading-indicator" style="padding: 40px; display: none;">
        Loading...
    </div>

    <div class="wrapper">
        <div class="header2 d-flex flex-md-row align-items-center px-3 py-2"
            style="justify-content: space-between; position: fixed; top: 0; left: 0; right: 0; z-index: 1030;">
            <div class="menu-hamburger">
                <i class="fa-sharp fa-solid fa-bars hamburger-menu" style="cursor: pointer;"></i>
                <span
                    style="color: whitesmoke; font-family: 'Suisse-SemiBold', 'Roboto', sans-serif; font-size: 1.5em; padding: 1px 0px 0px 24px;">One
                    Admin</span>
            </div>
            <div>
                <div class="header-main-new d-flex align-items-center">
                    <div class="header-parts-client">
                        <div>
                            <div class="institution-name">Cenlar FSB</div>
                        </div>
                        <div class="d-inline-block ms-md-2">
                            <select class="form-select header-main-1-formfld" name="channelSelect" id="channelSelect"
                                aria-label="Channel select">
                                <option selected>Borrower Self-Service</option>
                                <option value="1">Customer Service</option>
                                <option value="2">Loan Management</option>
                            </select>
                        </div>
                        <div class="d-inline-block ms-md-2">
                            <select class="form-select header-main-1-formfld" name="brandSelect" id="brandSelect"
                                aria-label="Brand select">
                                <option selected>All Brands</option>
                                <!-- Brand options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-icons" style="color: whitesmoke;">
                <i class="fa-sharp fa-regular fa-question-circle mat-mdc-tooltip-trigger"
                    style="color: whitesmoke; padding: 0px 8px; cursor: pointer;" title="Help Center"></i>
                <div class="dropdown loan-dropdown-menu">
                    <button class="btn dropdown-toggle d-inline-block px-0" type="button" id="userProfileDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false" style="color: whitesmoke;"
                        aria-label="User profile">
                        <div class="mat-mdc-menu-trigger">
                            <span>
                                <i class="fa-sharp fa-regular fa-circle-user mat-mdc-tooltip-trigger"
                                    style="color: whitesmoke;" title="User Profile Menu"></i>
                            </span>
                            <i class="material-icons align-middle" style="color: whitesmoke;">arrow_drop_down</i>
                        </div>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userProfileDropdown"
                        id="adminUserMenuId">
                        <li><a class="dropdown-item" href="#">Profile</a></li>
                        <li><a class="dropdown-item" href="#">Settings</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container-fluid" style="margin-top: 56px; padding: 0;">
            <div class="row g-0">
                <!-- Sidebar Navigation -->
                <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse mat-drawer app-drawer"
                    style="padding-top: 0; position: fixed; top: 56px; height: calc(100vh - 56px); z-index: 100; width: 216px; overflow-y: auto;">
                    <ul class="drawer-list-item">
                        <li class="drawer-list-item">
                            <a class="drawer-item" href="/admin/dashboard">
                                Dashboard
                            </a>
                        </li>
                        <ul>
                            <a href="javascript:void(0)" class="drawer-item">
                                Servicing Digital
                                <i class="fa-sharp fa-solid fa-caret-up caret-style"></i>
                            </a>
                            <div>
                                <li class="drawer-list-item">
                                    <a class="drawer-feature-item active-child-menu-item" href="/admin/borrower-admin">
                                        <div class="indicator"></div>
                                        <span class="drawer-feature-item-span">Borrowers</span>
                                    </a>
                                </li>
                                <li class="drawer-list-item">
                                    <a class="drawer-feature-item" href="/admin/messaging2">
                                        <div class="indicator"></div>
                                        <span class="drawer-feature-item-span">Messages</span>
                                    </a>
                                </li>
                                <li class="drawer-list-item">
                                    <a class="drawer-feature-item" href="/admin/queues">
                                        <div class="indicator"></div>
                                        <span class="drawer-feature-item-span">Queues</span>
                                    </a>
                                </li>
                                <li class="drawer-list-item">
                                    <a class="drawer-feature-item" href="/admin/statistics">
                                        <div class="indicator"></div>
                                        <span class="drawer-feature-item-span">Customer Statistics</span>
                                    </a>
                                </li>
                            </div>
                        </ul>
                        <ul style="display: none;">
                            <a href="javascript:void(0)" class="drawer-item">
                                Customer Service
                                <i class="fa-sharp fa-solid fa-caret-down caret-style"></i>
                            </a>
                        </ul>
                    </ul>
                </div>

                <!-- Main Content -->
                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 mat-drawer-content"
                    style="margin-left: 216px; padding-top: 10px; overflow-y: auto;">
                    <div class="header-main-1">
                        <h4>Search Borrowers</h4>
                        <div class="header-parts-client py-2">
                            <div class="search-links pr-4">
                                <a class="text-link" id="clearSearchBtn">Clear Search</a>
                            </div>
                        </div>
                    </div>

                    <div class="hero">
                        <div class="container xl">
                            <form id="borrowerSearchForm" name="form" autocomplete="off"
                                class="ng-untouched ng-pristine ng-valid" novalidate>
                                <div class="row">
                                    <div class="col-6 col-lg-4 col-xl-2 pr-lg-2 mb-2">
                                        <label for="userName" class="form-label small mb-1">Username</label>
                                        <input type="text" class="form-control form-control-sm mat-mdc-input-element"
                                            id="userName" name="userName" maxlength="30" autocomplete="off">
                                    </div>
                                    <div class="col-6 col-lg-4 col-xl-1 px-lg-2 mb-2">
                                        <label for="firstName" class="form-label small mb-1">First Name</label>
                                        <input type="text" class="form-control form-control-sm mat-mdc-input-element"
                                            id="firstName" name="firstName" maxlength="30" autocomplete="off">
                                    </div>
                                    <div class="col-6 col-lg-4 col-xl-1 px-lg-2 mb-2">
                                        <label for="lastName" class="form-label small mb-1">Last Name</label>
                                        <input type="text" class="form-control form-control-sm mat-mdc-input-element"
                                            id="lastName" name="lastName" maxlength="30" autocomplete="off">
                                    </div>
                                    <div class="col-6 col-lg-4 col-xl-2 px-lg-2 mb-2">
                                        <label for="email" class="form-label small mb-1">Email</label>
                                        <input type="email" class="form-control form-control-sm mat-mdc-input-element"
                                            id="email" name="email" autocomplete="off">
                                    </div>
                                    <div class="col-6 col-lg-4 col-xl-2 px-lg-2 mb-2">
                                        <label for="loanNumber" class="form-label small mb-1">Loan Number</label>
                                        <input type="text" class="form-control form-control-sm mat-mdc-input-element"
                                            id="loanNumber" name="loanNumber" autocomplete="off">
                                    </div>
                                    <div class="col-6 col-lg-4 col-xl-2 px-lg-2 mb-2">
                                        <label for="status" class="form-label small mb-1">Status</label>
                                        <select class="form-select form-select-sm" id="status" name="status">
                                            <option value="">All</option>
                                            <option value="active">Active</option>
                                            <option value="inactive">Inactive</option>
                                            <option value="pending">Pending</option>
                                        </select>
                                    </div>
                                    <div class="col-6 col-lg-4 col-xl-2 px-lg-2 mb-2">
                                        <label for="searchBrand" class="form-label small mb-1">Brand</label>
                                        <select class="form-select form-select-sm" id="searchBrand" name="searchBrand">
                                            <option value="">All Brands</option>
                                            <!-- Will be populated by JavaScript -->
                                        </select>
                                    </div>
                                    <div class="col-6 col-lg-4 col-xl-2 px-lg-2 mb-2">
                                        <label for="registrationDate" class="form-label small mb-1">Registration
                                            Date</label>
                                        <input type="date" class="form-control form-control-sm mat-mdc-input-element"
                                            id="registrationDate" name="registrationDate" autocomplete="off">
                                    </div>
                                    <div class="col-6 col-lg-4 col-xl-2 pl-lg-2 mb-2 d-flex align-items-end">
                                        <button type="button" id="searchButton"
                                            class="btn btn-primary btn-sm w-100">Search</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Create New Secure Message Card -->
                    <div class="card mt-2 mb-4">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Create a New Secure Message</h5>
                                <div>
                                    <button class="btn btn-outline-primary btn-sm" id="refreshLoansBtn">
                                        <i class="fa-solid fa-refresh me-1"></i> Refresh Loans
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <form id="secureMessageForm">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="loanPropertySelect" class="form-label">Select Loan/Property</label>
                                        <select class="form-select" id="loanPropertySelect" required>
                                            <option value="">-- Select a loan --</option>
                                            <!-- Will be populated from borrowersData -->
                                        </select>
                                        <small class="text-muted">Only loans you have access to will be
                                            displayed</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="messageCategory" class="form-label">Message Category</label>
                                        <select class="form-select" id="messageCategory" required>
                                            <option value="">-- Select a category --</option>
                                            <option value="payment">Payment</option>
                                            <option value="escrow">Escrow</option>
                                            <option value="insurance">Insurance</option>
                                            <option value="taxes">Taxes</option>
                                            <option value="general">General Inquiry</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="messageSubject" class="form-label">Subject</label>
                                    <input type="text" class="form-control" id="messageSubject" required>
                                </div>
                                <div class="mb-3">
                                    <label for="messageBody" class="form-label">Message</label>
                                    <textarea class="form-control" id="messageBody" rows="5" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="attachments" class="form-label">Attachments (Optional)</label>
                                    <input type="file" class="form-control" id="attachments" multiple>
                                </div>
                                <div class="d-flex justify-content-end">
                                    <button type="button" class="btn btn-outline-secondary me-2"
                                        id="cancelMessageBtn">Cancel</button>
                                    <button type="submit" class="btn btn-primary" id="sendMessageBtn">Send
                                        Message</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Borrowers List Card -->
                    <div class="card mt-2">
                        <div class="card-header bg-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">Borrowers List</h5>
                                <div>
                                    <button class="btn btn-outline-primary btn-sm">
                                        <i class="fa-solid fa-file-export me-1"></i> Export
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm ms-2">
                                        <i class="fa-solid fa-print me-1"></i> Print
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive ag-theme-alpine">
                                <table class="table borrowers-table" id="borrowersTable">
                                    <thead>
                                        <tr>
                                            <th class="grid-align-left" col-id="UserName">Username</th>
                                            <th class="grid-align-left" col-id="FullName">Name</th>
                                            <th class="grid-align-left" col-id="EmailAddress">Email</th>
                                            <th class="grid-align-left" col-id="LoanIdentifier">Loan Number</th>
                                            <th class="grid-align-left" col-id="Brand">Brand</th>
                                            <th class="grid-align-left" col-id="RegistrationDate">Registration Date</th>
                                            <th class="grid-align-left" col-id="Status">Status</th>
                                            <th class="grid-align-left" col-id="Actions">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Dummy data will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div>
                                    <span>Showing <span id="startRecord">1</span> to <span id="endRecord">10</span> of
                                        <span id="totalRecords">100</span> entries</span>
                                </div>
                                <nav aria-label="Borrowers pagination">
                                    <ul class="pagination mb-0 ag-paging-panel">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" tabindex="-1"
                                                aria-disabled="true">Previous</a>
                                        </li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                                        <li class="page-item">
                                            <a class="page-link" href="#">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Custom JavaScript -->
    <script>
        // Dummy data for borrowers
        const borrowersData = [
            {
                username: 'jsmith2023',
                firstName: 'John',
                lastName: 'Smith',
                email: 'john.smith@example.com',
                loanNumber: '0000000976',
                registrationDate: '2023-01-15',
                status: 'active'
            },
            {
                username: 'mjohnson',
                firstName: 'Mary',
                lastName: 'Johnson',
                email: 'mary.johnson@example.com',
                loanNumber: '0000000001',
                registrationDate: '2023-02-20',
                status: 'active'
            },
            {
                username: 'rwilliams',
                firstName: 'Robert',
                lastName: 'Williams',
                email: 'robert.williams@example.com',
                loanNumber: '0000001180',
                registrationDate: '2023-03-05',
                status: 'inactive'
            },
            {
                username: 'pbrown',
                firstName: 'Patricia',
                lastName: 'Brown',
                email: 'patricia.brown@example.com',
                loanNumber: '0000001081',
                registrationDate: '2023-03-18',
                status: 'pending'
            },
            {
                username: 'jdavis',
                firstName: 'James',
                lastName: 'Davis',
                email: 'james.davis@example.com',
                loanNumber: '0000001245',
                registrationDate: '2023-04-02',
                status: 'active'
            },
            {
                username: 'jmiller',
                firstName: 'Jennifer',
                lastName: 'Miller',
                email: 'jennifer.miller@example.com',
                loanNumber: '0000001302',
                registrationDate: '2023-04-15',
                status: 'active'
            },
            {
                username: 'dwilson',
                firstName: 'David',
                lastName: 'Wilson',
                email: 'david.wilson@example.com',
                loanNumber: '0000001356',
                registrationDate: '2023-05-01',
                status: 'inactive'
            },
            {
                username: 'lmoore',
                firstName: 'Linda',
                lastName: 'Moore',
                email: 'linda.moore@example.com',
                loanNumber: '0172505513',
                registrationDate: '2023-05-12',
                status: 'active'
            },
            {
                username: 'mtaylor',
                firstName: 'Michael',
                lastName: 'Taylor',
                email: 'michael.taylor@example.com',
                loanNumber: '0161786967',
                registrationDate: '2023-06-03',
                status: 'pending'
            },
            {
                username: 'eanderson',
                firstName: 'Elizabeth',
                lastName: 'Anderson',
                email: 'elizabeth.anderson@example.com',
                loanNumber: '0180995748',
                registrationDate: '2023-06-20',
                status: 'active'
            }
        ];

        // Brands data - banks or money lenders with associated loan numbers
        const brandsData = [
            {
                id: 1,
                name: 'Chase Bank',
                code: 'CHASE',
                loanNumbers: ['0172505513', '0000001245', '0000001470', '0000001485', '0000001499']
            },
            {
                id: 2,
                name: 'Bank of America',
                code: 'BOA',
                loanNumbers: ['0180995748', '0000001421', '0000001471', '0000001486', '0000001500']
            },
            {
                id: 3,
                name: 'Wells Fargo',
                code: 'WF',
                loanNumbers: ['0172505513', '0000001472', '0000001487', '0000001501', '0000001510']
            },
            {
                id: 4,
                name: 'Citibank',
                code: 'CITI',
                loanNumbers: ['0000001081', '0000001473', '0000001488', '0000001502', '0000001511']
            },
            {
                id: 5,
                name: 'US Bank',
                code: 'USB',
                loanNumbers: ['0000001302', '0000001474', '0000001489', '0000001503', '0000001512']
            },
            {
                id: 6,
                name: 'PNC Bank',
                code: 'PNC',
                loanNumbers: ['0000001356', '0000001475', '0000001490', '0000001504', '0000001513']
            },
            {
                id: 7,
                name: 'TD Bank',
                code: 'TD',
                loanNumbers: ['0000001489', '0000001476', '0000001491', '0000001505', '0000001514']
            },
            {
                id: 8,
                name: 'Capital One',
                code: 'CAP1',
                loanNumbers: ['0000001523', '0000001477', '0000001492', '0000001506', '0000001515']
            }
        ];

        // Function to find brand by loan number
        function findBrandByLoanNumber(loanNumber) {
            for (const brand of brandsData) {
                if (brand.loanNumbers.includes(loanNumber)) {
                    return brand;
                }
            }
            return null; // Return null if no brand is found for the loan number
        }

        // Function to populate the borrowers table
        function populateBorrowersTable(data) {
            const tableBody = document.querySelector('#borrowersTable tbody');
            tableBody.innerHTML = '';

            data.forEach(borrower => {
                const row = document.createElement('tr');

                // Status class based on borrower status
                let statusClass = '';
                if (borrower.status === 'active') {
                    statusClass = 'status-active';
                } else if (borrower.status === 'inactive') {
                    statusClass = 'status-inactive';
                } else if (borrower.status === 'pending') {
                    statusClass = 'status-pending';
                }

                // Format date
                const registrationDate = new Date(borrower.registrationDate);
                const formattedDate = registrationDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });

                // Ensure loan number is in the correct format (10 digits with leading zeros)
                const loanNumber = borrower.loanNumber.padStart(10, '0');

                // Find the brand associated with this loan number
                const brand = findBrandByLoanNumber(borrower.loanNumber);
                const brandDisplay = brand ?
                    `${brand.name} <span class="badge bg-secondary">${brand.code}</span>` :
                    'Not Assigned';

                row.innerHTML = `
                    <td>${borrower.username}</td>
                    <td>${borrower.firstName} ${borrower.lastName}</td>
                    <td>${borrower.email}</td>
                    <td>${loanNumber}</td>
                    <td>${brandDisplay}</td>
                    <td>${formattedDate}</td>
                    <td><span class="${statusClass}">${borrower.status.charAt(0).toUpperCase() + borrower.status.slice(1)}</span></td>
                    <td>
                        <i class="fa-solid fa-eye action-icon" title="View"></i>
                        <i class="fa-solid fa-pen-to-square action-icon" title="Edit"></i>
                        <i class="fa-solid fa-trash action-icon" title="Delete"></i>
                    </td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Function to populate brand dropdowns
        function populateBrandDropdowns() {
            // Populate header brand dropdown
            const brandSelect = document.getElementById('brandSelect');

            // Clear existing options except the first one (All Brands)
            while (brandSelect.options.length > 1) {
                brandSelect.remove(1);
            }

            // Add brand options
            brandsData.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand.id;
                option.textContent = `${brand.name} (${brand.code})`;
                brandSelect.appendChild(option);
            });

            // Populate search form brand dropdown
            const searchBrand = document.getElementById('searchBrand');

            // Clear existing options except the first one (All Brands)
            while (searchBrand.options.length > 1) {
                searchBrand.remove(1);
            }

            // Add brand options
            brandsData.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand.id;
                option.textContent = `${brand.name} (${brand.code})`;
                searchBrand.appendChild(option);
            });
        }

        // Function to filter borrowers based on search criteria
        function filterBorrowers() {
            const username = document.getElementById('userName').value.toLowerCase();
            const firstName = document.getElementById('firstName').value.toLowerCase();
            const lastName = document.getElementById('lastName').value.toLowerCase();
            const email = document.getElementById('email').value.toLowerCase();
            const loanNumber = document.getElementById('loanNumber').value.toLowerCase();
            const status = document.getElementById('status').value.toLowerCase();
            const registrationDate = document.getElementById('registrationDate').value;
            const selectedBrand = document.getElementById('brandSelect').value;
            const searchBrand = document.getElementById('searchBrand').value;

            const filteredData = borrowersData.filter(borrower => {
                // Find the brand for this loan number
                const brand = findBrandByLoanNumber(borrower.loanNumber);

                // Check if either the header brand dropdown or search form brand dropdown is filtering
                const headerBrandMatch = selectedBrand === 'All Brands' ||
                    (brand && brand.id.toString() === selectedBrand);
                const searchBrandMatch = searchBrand === '' ||
                    (brand && brand.id.toString() === searchBrand);

                return (
                    (username === '' || borrower.username.toLowerCase().includes(username)) &&
                    (firstName === '' || borrower.firstName.toLowerCase().includes(firstName)) &&
                    (lastName === '' || borrower.lastName.toLowerCase().includes(lastName)) &&
                    (email === '' || borrower.email.toLowerCase().includes(email)) &&
                    (loanNumber === '' || borrower.loanNumber.toLowerCase().includes(loanNumber)) &&
                    (status === '' || borrower.status === status) &&
                    (registrationDate === '' || borrower.registrationDate === registrationDate) &&
                    headerBrandMatch && searchBrandMatch
                );
            });

            populateBorrowersTable(filteredData);
            updatePagination(filteredData.length);
        }

        // Function to update pagination information
        function updatePagination(totalRecords) {
            document.getElementById('totalRecords').textContent = totalRecords;
            document.getElementById('endRecord').textContent = Math.min(10, totalRecords);
        }

        // Function to clear search form
        function clearSearch() {
            document.getElementById('borrowerSearchForm').reset();
            populateBorrowersTable(borrowersData);
            updatePagination(borrowersData.length);
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            // Show loading indicator for a moment to simulate Angular loading
            document.getElementById('loading-indicator').style.display = 'flex';
            setTimeout(() => {
                document.getElementById('loading-indicator').style.display = 'none';
            }, 1000);

            // Populate brand dropdowns
            populateBrandDropdowns();

            // Populate table with initial data
            populateBorrowersTable(borrowersData);
            updatePagination(borrowersData.length);

            // Add brand select change events
            document.getElementById('brandSelect').addEventListener('change', filterBorrowers);
            document.getElementById('searchBrand').addEventListener('change', filterBorrowers);

            // Search button click event
            document.getElementById('searchButton').addEventListener('click', filterBorrowers);

            // Clear search button click event
            document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);

            // Toggle sidebar menu items
            document.querySelector('.hamburger-menu').addEventListener('click', function () {
                document.querySelector('.sidebar').classList.toggle('show');
            });

            // Add click event to action icons (for demonstration)
            document.addEventListener('click', function (e) {
                if (e.target.classList.contains('action-icon')) {
                    const action = e.target.getAttribute('title');
                    const row = e.target.closest('tr');
                    const username = row.cells[0].textContent;

                    alert(`${action} action for borrower: ${username}`);
                }
            });

            // Add click event to drawer items
            document.querySelectorAll('.drawer-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    if (this.nextElementSibling && this.nextElementSibling.tagName === 'DIV') {
                        e.preventDefault();
                        const submenu = this.nextElementSibling;
                        const caret = this.querySelector('.caret-style');

                        if (submenu.style.display === 'none') {
                            submenu.style.display = 'block';
                            if (caret) {
                                caret.classList.remove('fa-caret-down');
                                caret.classList.add('fa-caret-up');
                            }
                        } else {
                            submenu.style.display = 'none';
                            if (caret) {
                                caret.classList.remove('fa-caret-up');
                                caret.classList.add('fa-caret-down');
                            }
                        }
                    }
                });
            });

            // Secure Message Form Functionality
            // Populate loan dropdown from borrowersData
            function populateLoanDropdown() {
                const loanSelect = document.getElementById('loanPropertySelect');

                // Clear existing options except the first one
                while (loanSelect.options.length > 1) {
                    loanSelect.remove(1);
                }

                // Create a Set to track unique loan numbers
                const uniqueLoans = new Set();

                // Process each borrower
                borrowersData.forEach(borrower => {
                    // Skip if we've already added this loan
                    if (uniqueLoans.has(borrower.loanNumber)) {
                        return;
                    }

                    uniqueLoans.add(borrower.loanNumber);

                    // Find the brand associated with this loan number
                    const brand = findBrandByLoanNumber(borrower.loanNumber);

                    // Create property info object
                    const propertyInfo = {
                        address: generateMockAddress(borrower.loanNumber),
                        propertyType: generateMockPropertyType(borrower.loanNumber),
                        loanType: generateMockLoanType(borrower.loanNumber),
                        borrowerName: `${borrower.firstName} ${borrower.lastName}`,
                        brand: brand ? brand.name : 'Unknown'
                    };

                    // Create and add the option
                    const option = document.createElement('option');
                    option.value = borrower.loanNumber;
                    option.text = `${borrower.loanNumber} - ${propertyInfo.address}`;
                    option.dataset.propertyInfo = JSON.stringify(propertyInfo);
                    loanSelect.add(option);
                });

                // If no loans were added, show a message
                if (uniqueLoans.size === 0) {
                    const noLoansOption = document.createElement('option');
                    noLoansOption.text = 'No loans available';
                    noLoansOption.disabled = true;
                    loanSelect.add(noLoansOption);
                }
            }

            // Helper functions to generate mock property data
            function generateMockAddress(loanNumber) {
                // Extract last 4 digits of loan number
                const lastDigits = loanNumber.slice(-4);
                const num = parseInt(lastDigits) % 1000;

                const streets = ['Main St', 'Oak Ave', 'Pine Blvd', 'Maple Dr', 'Cedar Ln', 'Elm St', 'Washington Ave'];
                const cities = ['Anytown', 'Springfield', 'Lakeside', 'Riverdale', 'Mountainview', 'Westfield', 'Oakdale'];
                const states = ['CA', 'IL', 'TX', 'NY', 'FL', 'WA', 'MA'];

                const streetIndex = num % streets.length;
                const cityIndex = (num + 1) % cities.length;
                const stateIndex = (num + 2) % states.length;

                return `${100 + num} ${streets[streetIndex]}, ${cities[cityIndex]}, ${states[stateIndex]} ${10000 + num}`;
            }

            function generateMockPropertyType(loanNumber) {
                const types = ['Single Family', 'Condo', 'Townhouse', 'Multi-Family', 'Duplex', 'Apartment'];
                const index = parseInt(loanNumber.slice(-1)) % types.length;
                return types[index];
            }

            function generateMockLoanType(loanNumber) {
                const types = ['Conventional', 'FHA', 'VA', 'USDA', 'Jumbo', 'Fixed Rate', 'ARM'];
                const index = parseInt(loanNumber.slice(-2, -1)) % types.length;
                return types[index];
            }

            // Initialize loan dropdown
            populateLoanDropdown();

            // Handle secure message form submission
            document.getElementById('secureMessageForm').addEventListener('submit', function (e) {
                e.preventDefault();

                const loanSelect = document.getElementById('loanPropertySelect');
                const messageCategory = document.getElementById('messageCategory');
                const messageSubject = document.getElementById('messageSubject');
                const messageBody = document.getElementById('messageBody');

                // Validate form
                if (loanSelect.value === '' || messageCategory.value === '' ||
                    messageSubject.value.trim() === '' || messageBody.value.trim() === '') {
                    alert('Please fill in all required fields');
                    return;
                }

                // Get selected loan property info
                let propertyInfo = {};
                if (loanSelect.selectedIndex > 0) {
                    try {
                        propertyInfo = JSON.parse(loanSelect.options[loanSelect.selectedIndex].dataset.propertyInfo);
                    } catch (e) {
                        console.error('Error parsing property info:', e);
                    }
                }

                // In a real implementation, you would send this data to an API
                const messageData = {
                    loanNumber: loanSelect.value,
                    propertyInfo: propertyInfo,
                    category: messageCategory.value,
                    subject: messageSubject.value,
                    message: messageBody.value,
                    attachments: Array.from(document.getElementById('attachments').files).map(file => file.name),
                    timestamp: new Date().toISOString()
                };

                console.log('Sending secure message:', messageData);

                // Show success message
                alert('Your message has been sent successfully!');

                // Reset form
                this.reset();
            });

            // Handle cancel button
            document.getElementById('cancelMessageBtn').addEventListener('click', function () {
                document.getElementById('secureMessageForm').reset();
            });

            // Handle refresh loans button - repopulates the dropdown and shows feedback
            document.getElementById('refreshLoansBtn').addEventListener('click', function () {
                // Repopulate the dropdown
                populateLoanDropdown();

                // Show a feedback message to the user
                const feedbackMsg = document.createElement('div');
                feedbackMsg.className = 'alert alert-info mt-2 mb-2';
                feedbackMsg.textContent = 'Loan list refreshed';
                feedbackMsg.style.padding = '5px 10px';
                feedbackMsg.style.fontSize = '0.9rem';

                // Insert after the dropdown
                const loanSelectParent = document.getElementById('loanPropertySelect').parentNode;

                // Remove any existing feedback message
                const existingMsg = loanSelectParent.querySelector('.alert-info');
                if (existingMsg) {
                    existingMsg.remove();
                }

                loanSelectParent.appendChild(feedbackMsg);

                // Remove the message after 2 seconds
                setTimeout(() => {
                    feedbackMsg.remove();
                }, 2000);
            });
        });
    </script>
    <script src="./loan_filter_updated.js" type="module" defer></script>
</body>

</html>