<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoanSphere Messages</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- AngularJS and Angular Material -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.2.5/angular-material.min.js"></script>
    <link href="https://ajax.googleapis.com/ajax/libs/angular_material/1.2.5/angular-material.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-aria.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-animate.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --text-light: #ecf0f1;
            --background-color: #f5f6fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            color: var(--primary-color);
        }

        .wrapper {
            min-height: 100vh;
            background-color: white;
            box-shadow: var(--box-shadow);
        }

        .header2 {
            background-color: var(--primary-color);
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: var(--text-light);
        }

        .menu-hamburger {
            display: flex;
            align-items: center;
        }

        .hamburger-menu {
            color: var(--text-light);
            font-size: 1.5rem;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .hamburger-menu:hover {
            color: var(--accent-color);
        }

        .header-main-1 {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
        }

        .header-parts-client {
            color: var(--text-light);
        }

        .institution-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .content-wrapper {
            padding: 2rem;
            background-color: var(--background-color);
        }

        .searchgrid {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }

        .form-select,
        .form-control {
            display: block;
            width: 100%;
            height: 40px;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            margin: 8px 0;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-select:focus,
        .form-control:focus {
            border-color: var(--accent-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .info-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .material-icons {
            color: var(--accent-color);
            transition: transform 0.2s ease;
            font-size: 22px;
        }

        .material-icons:hover {
            transform: scale(1.1);
            color: #2980b9;
        }

        .ag-theme-material {
            --ag-header-height: 56px;
            --ag-header-background-color: #f8f9fa;
            --ag-header-foreground-color: var(--primary-color);
            --ag-header-cell-hover-background-color: #edf2f7;
            --ag-row-hover-color: #f1f5f9;
        }

        .ag-header-cell {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .ag-header-cell-text {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 14px;
        }

        .ag-row:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 1rem;
            }

            .searchgrid {
                padding: 1rem;
            }
        }

        .form-switch .form-check-input {
            width: 3em;
            cursor: pointer;
        }

        .form-switch .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .form-check-label {
            cursor: pointer;
        }
    </style>
    <!-- Add these in the head section after existing CSS links -->
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-material.css">
</head>

<body ng-app="loanApp" ng-controller="LoanController">
    <div id="loading-indicator" style="padding: 40px; display: none;">
        Loading...
    </div>
    <div class="wrapper">
        <header class="header2 d-flex flex-column flex-md-row align-items-center px-3 py-2">
            <div class="menu-hamburger">
                <i class="fas fa-bars hamburger-menu"></i>
                <span
                    style="color: whitesmoke; font-family: 'Suisse-SemiBold'; font-size: 1.5em; padding: 1px 0px 0px 24px;">
                    One Admin
                </span>
            </div>
            <div class="header-main-1 header-main-new ms-auto">
                <div class="header-parts-client py-2">
                    <div class="institution-name ng-star-inserted">Cenlar FSB</div>
                    <div class="form-group d-flex align-items-center">
                        <label class="me-3 text-light">User Type:</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="userTypeSwitch" ng-model="isOffshore"
                                ng-change="updateUserType()">
                            <label class="form-check-label text-light" for="userTypeSwitch">{{isOffshore ? 'Offshore' :
                                'Onshore'}}</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <select class="form-select" ng-model="selectedLoan">
                            <option value="" disabled>Select Loan</option>
                            <option ng-repeat="loan in getAccessibleLoans()" value="{{loan.id}}">
                                {{loan.loanNumber}} - {{loan.propertyInfo}}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-select" ng-model="selectedChannel">
                            <option ng-repeat="channel in channels" value="{{channel.id}}">{{channel.name}}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-select" ng-model="selectedBrand">
                            <option ng-repeat="brand in getAccessibleBrands()" ng-value="brand">{{brand.name}}</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>
        <main class="content-wrapper">
            <div class="container searchgrid">
                <div class="alert alert-warning" ng-if="restrictionMessage">
                    {{ restrictionMessage }}
                </div>
                <div class="info-section">
                    <i class="material-icons">info_outline</i>
                    <span class="info-text">How header filtering works</span>
                </div>
                <form novalidate="" name="form" autocomplete="off" class="ng-untouched ng-pristine ng-valid">
                    <div class="flex-row-container flex-wrap">
                        <div class="form-group">
                            <label>Queue</label>
                            <select class="form-select" ng-model="selectedQueue" multiple
                                aria-describedby="cdk-describedby-message-ng-1-10">
                                <option ng-repeat="queue in queues" value="{{queue.id}}">{{queue.Value}}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select class="form-select" ng-model="selectedCategory"
                                aria-describedby="cdk-describedby-message-ng-1-11">
                                <option value="" disabled>Select Category</option>
                                <option ng-repeat="category in categories" value="{{category.id}}">
                                    {{category.CategoryName}}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" class="form-control" ng-model="firstName" placeholder="Enter First Name"
                                aria-describedby="cdk-describedby-message-ng-1-12">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" class="form-control" ng-model="lastName" placeholder="Enter Last Name"
                                aria-describedby="cdk-describedby-message-ng-1-13">
                        </div>
                        <div class="form-group">
                            <label>Loan Number</label>
                            <input type="text" class="form-control" ng-model="loanNumber"
                                placeholder="Enter Loan Number" aria-describedby="cdk-describedby-message-ng-1-14">
                        </div>
                        <div class="form-group">
                            <label>Show Deleted</label>
                            <select class="form-select" ng-model="showDeleted"
                                aria-describedby="cdk-describedby-message-ng-1-16">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" class="form-control" ng-model="startDate"
                                aria-describedby="cdk-describedby-message-ng-1-17">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" class="form-control" ng-model="endDate"
                                aria-describedby="cdk-describedby-message-ng-1-18">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" ng-click="searchLoans()">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button class="btn btn-secondary ms-2" ng-click="refreshResults()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="btn btn-info ms-2" ng-click="returnToMessages()">
                                <i class="fas fa-arrow-left"></i> Return to Messages
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger" ng-repeat="loan in getAccessibleLoans()"
                                ng-click="removeLoan(loan.id)" ng-if="canRemoveLoan(loan.id)"
                                style="margin-right: 10px;">
                                Remove {{loan.loanNumber}}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="container searchgrid">
                <div class="info-section">
                    <i class="material-icons">info_outline</i>
                    <span class="info-text">How column sorting and filtering works</span>
                </div>
                <mat-card appearance="outlined"
                    class="mat-mdc-card mdc-card p-0 mat-mdc-card-outlined mdc-card--outlined">
                    <!-- Replace the ag-grid div with this table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Message Date</th>
                                    <th>Sender</th>
                                    <th>Message</th>
                                    <th>Queue</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Loan Number</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="message in searchResults">
                                    <td>{{message.messageDate}}</td>
                                    <td>{{message.sender}}</td>
                                    <td>{{message.messageText}}</td>
                                    <td>{{getQueueName(message.queueId)}}</td>
                                    <td>{{getCategoryName(message.categoryId)}}</td>
                                    <td>{{getStatusName(message.statusId)}}</td>
                                    <td>{{getLoanNumber(message.loanId)}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </mat-card>
            </div>
        </main>
    </div>

    <div class="cdk-live-announcer-element cdk-visually-hidden" aria-atomic="true" aria-live="polite"
        id="cdk-live-announcer-0"></div>
    <div class="cdk-overlay-container"></div>
    <div class="cdk-describedby-message-container cdk-visually-hidden" style="visibility: hidden;">
        <div id="cdk-describedby-message-ng-1-8" role="tooltip">Help Center</div>
        <div id="cdk-describedby-message-ng-1-9" role="tooltip">User Profile Menu</div>
        <div id="cdk-describedby-message-ng-1-10" role="tooltip">Show Message Threads in selected Queue(s)</div>
        <div id="cdk-describedby-message-ng-1-11" role="tooltip">Show Message Threads in selected Category</div>
        <div id="cdk-describedby-message-ng-1-12" role="tooltip">Show Message Threads from Borrower(s) with specified
            First Name</div>
        <div id="cdk-describedby-message-ng-1-13" role="tooltip">Show Message Threads from Borrower(s) with specified
            Last Name</div>
        <div id="cdk-describedby-message-ng-1-14" role="tooltip">Show Message Threads from Borrower(s) with specified
            Loan Number</div>
        <div id="cdk-describedby-message-ng-1-15" role="tooltip">Show Message Threads with selected Status</div>
        <div id="cdk-describedby-message-ng-1-16" role="tooltip">Show Message Threads that Borrowers have Deleted</div>
        <div id="cdk-describedby-message-ng-1-17" role="tooltip">Show Message Threads with Borrower Message Date on or
            after selected date</div>
        <div id="cdk-describedby-message-ng-1-18" role="tooltip">Show Message Threads with Borrower Message Date on or
            before selected date</div>
        <div id="cdk-describedby-message-ng-1-19" role="tooltip">Filtering applies to all message threads and search
            results are sorted by Borrower Message Date.</div>
        <div id="cdk-describedby-message-ng-1-20" role="tooltip">Sorting/filtering applies only to the current search
            results page.</div>
    </div>

    <!-- Bootstrap and AngularJS Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
    <script>
        var app = angular.module('loanApp', ['ngMaterial', 'ngAria', 'ngAnimate']);



        app.controller('LoanController', function ($scope) {

            $scope.loans = [
                {
                    id: 1, loanNumber: "LOAN001", propertyInfo: "123 Main St", borrowerName: "John Doe",
                    queueId: 1, categoryId: 1, statusId: 1, messageDate: "2024-01-15",
                    allowedUserTypes: ['onshore', 'offshore'], brandId: 2
                },
                {
                    id: 2, loanNumber: "LOAN002", propertyInfo: "456 Oak Ave", borrowerName: "Jane Smith",
                    queueId: 2, categoryId: 2, statusId: 2, messageDate: "2024-01-16",
                    allowedUserTypes: ['onshore'], brandId: 3
                },
                {
                    id: 20, loanNumber: "LOAN020", propertyInfo: "789 Pine Rd", borrowerName: "Peter Parker",
                    queueId: 3, categoryId: 3, statusId: 1, messageDate: "2024-01-20",
                    allowedUserTypes: ['onshore', 'offshore'], brandId: 4
                },
                {
                    id: 3, loanNumber: "LOAN003", propertyInfo: "101 Elm St", borrowerName: "Alice Johnson",
                    queueId: 1, categoryId: 2, statusId: 3, messageDate: "2024-01-17",
                    allowedUserTypes: ['offshore'], brandId: 2
                },
                {
                    id: 4, loanNumber: "LOAN004", propertyInfo: "222 Maple Ave", borrowerName: "Bob Williams",
                    queueId: 2, categoryId: 1, statusId: 1, messageDate: "2024-01-18",
                    allowedUserTypes: ['onshore'], brandId: 3
                },
                {
                    id: 5, loanNumber: "LOAN005", propertyInfo: "333 Cedar Rd", borrowerName: "Charlie Brown",
                    queueId: 3, categoryId: 3, statusId: 2, messageDate: "2024-01-19",
                    allowedUserTypes: ['onshore', 'offshore'], brandId: 3
                },
                {
                    id: 6, loanNumber: "LOAN006", propertyInfo: "444 Birch Ln", borrowerName: "David Lee",
                    queueId: 1, categoryId: 1, statusId: 1, messageDate: "2024-01-21",
                    allowedUserTypes: ['offshore'], brandId: 4
                },
                {
                    id: 7, loanNumber: "LOAN007", propertyInfo: "555 Willow Dr", borrowerName: "Eva Davis",
                    queueId: 2, categoryId: 2, statusId: 3, messageDate: "2024-01-22",
                    allowedUserTypes: ['onshore'], brandId: 2
                },
                {
                    id: 8, loanNumber: "LOAN008", propertyInfo: "666 Spruce Ct", borrowerName: "Frank Wilson",
                    queueId: 3, categoryId: 3, statusId: 2, messageDate: "2024-01-23",
                    allowedUserTypes: ['onshore', 'offshore'], brandId: 5
                },
                {
                    id: 9, loanNumber: "LOAN009", propertyInfo: "777 Redwood Pl", borrowerName: "Grace Moore",
                    queueId: 1, categoryId: 1, statusId: 1, messageDate: "2024-01-24",
                    allowedUserTypes: ['onshore'], brandId: 3
                },
                {
                    id: 10, loanNumber: "LOAN010", propertyInfo: "888 Cherry Ave", borrowerName: "Henry Taylor",
                    queueId: 2, categoryId: 2, statusId: 3, messageDate: "2024-01-25",
                    allowedUserTypes: ['offshore'], brandId: 4
                },
                {
                    id: 11, loanNumber: "LOAN011", propertyInfo: "999 Walnut St", borrowerName: "Ivy Anderson",
                    queueId: 3, categoryId: 3, statusId: 2, messageDate: "2024-01-26",
                    allowedUserTypes: ['onshore', 'offshore'], brandId: 2
                },
                {
                    id: 12, loanNumber: "LOAN012", propertyInfo: "111 Pinecrest Ln", borrowerName: "Jack Thomas",
                    queueId: 1, categoryId: 1, statusId: 1, messageDate: "2024-01-27",
                    allowedUserTypes: ['onshore'], brandId: 2
                },
                {
                    id: 13, loanNumber: "LOAN013", propertyInfo: "222 River Rd", borrowerName: "Kelly White",
                    queueId: 2, categoryId: 2, statusId: 3, messageDate: "2024-01-28",
                    allowedUserTypes: ['offshore'], brandId: 3
                }
            ];


            $scope.getLoanNumber = function (loanId) {
                const loan = $scope.loans.find(l => l.id === loanId);
                return loan ? loan.loanNumber : '';
            };

            $scope.messages = [
                {
                    id: 1, loanId: 1, categoryId: 1, brandId: 2, queueId: 1, statusId: 1, messageText: "Payment confirmation received", messageDate: "2024-01-15", sender: "John Doe", allowedUserTypes: ['onshore', 'offshore']
                },
                {
                    id: 2, loanId: 1, categoryId: 2, brandId: 2, queueId: 2, statusId: 2, messageText: "Payment schedule update", messageDate: "2024-01-16", sender: "System", allowedUserTypes: ['onshore']
                },
                {
                    id: 3, loanId: 2, categoryId: 3, brandId: 3, queueId: 3, statusId: 3, messageText: "Document verification pending", messageDate: "2024-01-17", sender: "Jane Smith", allowedUserTypes: ['offshore']
                },
                {
                    id: 4, loanId: 2, categoryId: 1, brandId: 3, queueId: 1, statusId: 1, messageText: "Loan application approved", messageDate: "2024-01-18", sender: "System", allowedUserTypes: ['onshore']
                },
                {
                    id: 5, loanId: 3, categoryId: 2, brandId: 4, queueId: 2, statusId: 2, messageText: "Interest rate change notification", messageDate: "2024-01-19", sender: "Peter Parker", allowedUserTypes: ['onshore', 'offshore']
                },
                {
                    id: 6, loanId: 3, categoryId: 3, brandId: 4, queueId: 3, statusId: 3, messageText: "Additional documents requested", messageDate: "2024-01-20", sender: "System", allowedUserTypes: ['offshore']
                },
                {
                    id: 7, loanId: 4, categoryId: 1, brandId: 2, queueId: 1, statusId: 1, messageText: "Loan disbursement successful", messageDate: "2024-01-21", sender: "Alice Johnson", allowedUserTypes: ['onshore']
                },
                {
                    id: 8, loanId: 4, categoryId: 2, brandId: 2, queueId: 2, statusId: 2, messageText: "First payment reminder", messageDate: "2024-01-22", sender: "System", allowedUserTypes: ['onshore', 'offshore']
                },
                {
                    id: 9, loanId: 5, categoryId: 3, brandId: 5, queueId: 3, statusId: 3, messageText: "Property appraisal completed", messageDate: "2024-01-23", sender: "Bob Williams", allowedUserTypes: ['offshore']
                },
                {
                    id: 10, loanId: 5, categoryId: 1, brandId: 5, queueId: 1, statusId: 1, messageText: "Loan terms and conditions updated", messageDate: "2024-01-24", sender: "System", allowedUserTypes: ['onshore']
                },
                {
                    id: 11, loanId: 6, categoryId: 2, brandId: 3, queueId: 2, statusId: 2, messageText: "Early repayment option available", messageDate: "2024-01-25", sender: "Charlie Brown", allowedUserTypes: ['onshore', 'offshore']
                },
                {
                    id: 12, loanId: 6, categoryId: 3, brandId: 3, queueId: 3, statusId: 3, messageText: "Credit score review required", messageDate: "2024-01-26", sender: "System", allowedUserTypes: ['offshore']
                },
                {
                    id: 13, loanId: 7, categoryId: 1, brandId: 4, queueId: 1, statusId: 1, messageText: "Loan closed successfully", messageDate: "2024-01-27", sender: "David Lee", allowedUserTypes: ['onshore']
                },
                {
                    id: 14, loanId: 7, categoryId: 2, brandId: 4, queueId: 2, statusId: 2, messageText: "Final payment confirmation", messageDate: "2024-01-28", sender: "System", allowedUserTypes: ['onshore', 'offshore']
                },
                {
                    id: 15, loanId: 8, categoryId: 3, brandId: 2, queueId: 3, statusId: 3, messageText: "Escrow account balance update", messageDate: "2024-01-29", sender: "Eva Davis", allowedUserTypes: ['offshore']
                },
                {
                    id: 16, loanId: 8, categoryId: 1, brandId: 2, queueId: 1, statusId: 1, messageText: "Tax document upload reminder", messageDate: "2024-01-30", sender: "System", allowedUserTypes: ['onshore']
                },
                {
                    id: 17, loanId: 9, categoryId: 2, brandId: 5, queueId: 2, statusId: 2, messageText: "Refinance options available", messageDate: "2024-01-31", sender: "Frank Wilson", allowedUserTypes: ['onshore', 'offshore']
                },
                {
                    id: 18, loanId: 9, categoryId: 3, brandId: 5, queueId: 3, statusId: 3, messageText: "Insurance policy expiration notice", messageDate: "2024-02-01", sender: "System", allowedUserTypes: ['offshore']
                },
                {
                    id: 19, loanId: 10, categoryId: 1, brandId: 3, queueId: 1, statusId: 1, messageText: "Loan modification approved", messageDate: "2024-02-02", sender: "Grace Moore", allowedUserTypes: ['onshore']
                },
                {
                    id: 20, loanId: 10, categoryId: 2, brandId: 3, queueId: 2, statusId: 2, messageText: "Late payment fee applied", messageDate: "2024-02-03", sender: "System", allowedUserTypes: ['onshore', 'offshore']
                },
                {
                    id: 21, loanId: 11, categoryId: 3, brandId: 4, queueId: 3, statusId: 3, messageText: "Prepayment penalty details", messageDate: "2024-02-04", sender: "Henry Taylor", allowedUserTypes: ['offshore']
                },
                {
                    id: 22, loanId: 11, categoryId: 1, brandId: 4, queueId: 1, statusId: 1, messageText: "Automated payment setup confirmation", messageDate: "2024-02-05", sender: "System", allowedUserTypes: ['onshore']
                },
                {
                    id: 23, loanId: 12, categoryId: 2, brandId: 5, queueId: 2, statusId: 2, messageText: "Property tax payment due", messageDate: "2024-02-06", sender: "Jack Thomas", allowedUserTypes: ['onshore', 'offshore']
                },
                {
                    id: 24, loanId: 12, categoryId: 3, brandId: 5, queueId: 3, statusId: 3, messageText: "Homeowner's insurance renewal reminder", messageDate: "2024-02-07", sender: "System", allowedUserTypes: ['offshore']
                },
                {
                    id: 25, loanId: 13, categoryId: 1, brandId: 3, queueId: 1, statusId: 1, messageText: "Loan application submitted", messageDate: "2024-02-08", sender: "Kelly White", allowedUserTypes: ['onshore']
                }
            ];
         

            // Dummy data
            $scope.queues = [
                { id: 1, Value: "Default Queue" },
                { id: 2, Value: "High Priority" },
                { id: 3, Value: "Customer Service" },
                { id: 4, Value: "Technical Support" }
            ];

            $scope.brands = [
    { id: 1, name: "All Brands", allowedUserTypes: ['onshore', 'offshore'] },
    { id: 2, name: "Brand A", allowedUserTypes: ['onshore'] },
    { id: 3, name: "Brand B", allowedUserTypes: ['onshore'] },
    { id: 4, name: "Brand C", allowedUserTypes: ['offshore'] },
    { id: 5, name: "Brand D", allowedUserTypes: ['offshore'] }
];

            $scope.categories = [
                { id: 1, CategoryName: "General Inquiry" },
                { id: 2, CategoryName: "Payment Issues" },
                { id: 3, CategoryName: "Loan Application" },
                { id: 4, CategoryName: "Technical Support" }
            ];

            $scope.channels = [
                { id: 1, name: "Borrower Self-Service" },
                { id: 2, name: "Customer Portal" },
                { id: 3, name: "Mobile App" }
            ];

            $scope.statuses = [
                { id: 1, StatusName: "Active" },
                { id: 2, StatusName: "Pending" },
                { id: 3, StatusName: "Completed" },
                { id: 4, StatusName: "On Hold" }
            ];
            $scope.getQueueName = function (queueId) {
                const queue = $scope.queues.find(q => q.id === parseInt(queueId));
                return queue ? queue.Value : '';
            };

            $scope.returnToMessages = function() {
    // Reset filters
    $scope.selectedQueue = [];
    $scope.selectedCategory = null;
    $scope.selectedStatus = null;
    $scope.startDate = null;
    $scope.endDate = null;
    $scope.selectedLoan = null;
    
    // For offshore users, show only unrestricted messages
    if ($scope.userType === 'offshore') {
        $scope.searchResults = $scope.messages.filter(message => {
            // Check if the loan is accessible to offshore users
            const loan = $scope.loans.find(l => l.id === message.loanId);
            return loan && loan.allowedUserTypes.includes('offshore');
        });
    } else {
        // Onshore users can see all messages
        $scope.searchResults = $scope.messages;
    }
    
    // Sort by date
    $scope.searchResults.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));
};

            $scope.getCategoryName = function (categoryId) {
                const category = $scope.categories.find(c => c.id === parseInt(categoryId));
                return category ? category.CategoryName : '';
            };

            $scope.getAccessibleBrands = function() {
    return $scope.brands.filter(brand => 
        brand.id === 1 || brand.allowedUserTypes.includes($scope.userType)
    );
};

            $scope.getStatusName = function (statusId) {
                const status = $scope.statuses.find(s => s.id === parseInt(statusId));
                return status ? status.StatusName : '';
            };

            $scope.selectedQueue = [];
            $scope.selectedCategory = null;
            $scope.selectedChannel = $scope.channels[0];
            $scope.selectedBrand = $scope.brands[0];
            $scope.selectedStatus = null;
            $scope.isOffshore = false;
            $scope.userType = 'onshore';

            $scope.updateUserType = function () {
                $scope.userType = $scope.isOffshore ? 'offshore' : 'onshore';
                $scope.selectedLoan = null;

                if ($scope.isOffshore) {
                    $scope.searchResults = $scope.messages.filter(message => message.allowedUserTypes.includes('offshore'));
                } else {
                    $scope.searchLoans();
                }
            };

            
            $scope.getAccessibleLoans = function () {
                if ($scope.userType === 'onshore') {
                    return $scope.loans; // Onshore users can access all loans
                }
                // Offshore users can only access unrestricted loans
                return $scope.loans.filter(loan => loan.allowedUserTypes.includes('offshore'));
            };

            $scope.canRemoveLoan = function (loanId) {
                const loan = $scope.loans.find(l => l.id === loanId);
                if (!loan) return false;

                // Only allow removal if the loan is non-restricted (accessible to both user types)
                return loan.allowedUserTypes.includes('onshore') && loan.allowedUserTypes.includes('offshore');
            };
            $scope.selectedLoan = null;


            $scope.restrictionMessage = '';

            $scope.gridOptions = {
                columnDefs: [
                    { field: 'loanNumber', headerName: 'Loan Number', sortable: true, filter: true },
                    { field: 'borrowerName', headerName: 'Borrower Name', sortable: true, filter: true },
                    { field: 'propertyInfo', headerName: 'Property Info', sortable: true, filter: true },
                    {
                        field: 'queueId',
                        headerName: 'Queue',
                        sortable: true,
                        filter: true,
                        valueGetter: function (params) {
                            const queue = $scope.queues.find(q => q.id === parseInt(params.data.queueId));
                            return queue ? queue.Value : '';
                        }
                    },
                    {
                        field: 'categoryId',
                        headerName: 'Category',
                        sortable: true,
                        filter: true,
                        valueGetter: function (params) {
                            const category = $scope.categories.find(c => c.id === parseInt(params.data.categoryId));
                            return category ? category.CategoryName : '';
                        }
                    },
                    {
                        field: 'statusId',
                        headerName: 'Status',
                        sortable: true,
                        filter: true,
                        valueGetter: function (params) {
                            const status = $scope.statuses.find(s => s.id === parseInt(params.data.statusId));
                            return status ? status.StatusName : '';
                        }
                    },
                    { field: 'messageDate', headerName: 'Message Date', sortable: true, filter: true }
                ],
                defaultColDef: {
                    flex: 1,
                    minWidth: 150,
                    resizable: true
                },
                domLayout: 'normal',
                rowData: $scope.loans,
                onGridReady: function (params) {
                    $scope.gridApi = params.api;
                    params.api.sizeColumnsToFit();
                }
            };

            $scope.updateUserType = function () {
        $scope.userType = $scope.isOffshore ? 'offshore' : 'onshore';
        $scope.selectedLoan = null;
        $scope.searchLoans(); // This will handle both onshore and offshore cases
    };

            // Add refresh function
            $scope.refreshResults = function () {
                $scope.selectedQueue = [];
                $scope.selectedCategory = null;
                $scope.selectedStatus = null;
                $scope.startDate = null;
                $scope.endDate = null;

                let results = $scope.messages;
                if ($scope.userType === 'offshore') {
                    results = results.filter(message => message.allowedUserTypes.includes('offshore'));
                }

                results.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));
                $scope.searchResults = results;
            };
            // Update searchLoans function to use the same restriction logic
            $scope.searchLoans = function () {
    // Security check for offshore users
    if ($scope.userType === 'offshore' && !$scope.isOffshore) {
        $scope.restrictionMessage = "Access restricted. Please verify your user type.";
        $scope.searchResults = [];
        return;
    }

    let results = $scope.messages.filter(message => {
        const loan = $scope.loans.find(l => l.id === message.loanId);
        if (!loan) return false;

        // Check if searching by loan number for offshore users
        if ($scope.userType === 'offshore' && $scope.loanNumber) {
            if (!loan.allowedUserTypes.includes('offshore')) {
                $scope.restrictionMessage = "Loan is not provisioned to the user";
                return false;
            }
        }

        // Enhanced security check for offshore users
        if ($scope.userType === 'offshore') {
            if (!loan.allowedUserTypes.includes('offshore') || 
                !message.allowedUserTypes.includes('offshore')) {
                return false;
            }
        }

        // Rest of the filter logic
        const brand = $scope.brands.find(b => b.id === message.brandId);
        const brandAccessible = brand && (
            brand.id === 1 || 
            brand.allowedUserTypes.includes($scope.userType)
        );

        const loanMatch = !$scope.loanNumber || loan.loanNumber.toLowerCase().includes($scope.loanNumber.toLowerCase());
        const queueMatch = !$scope.selectedQueue.length || $scope.selectedQueue.includes(message.queueId.toString());
        const categoryMatch = !$scope.selectedCategory || message.categoryId.toString() === $scope.selectedCategory;
        const firstNameMatch = !$scope.firstName || loan.borrowerName.toLowerCase().includes($scope.firstName.toLowerCase());
        const lastNameMatch = !$scope.lastName || loan.borrowerName.toLowerCase().includes($scope.lastName.toLowerCase());
        const statusMatch = !$scope.selectedStatus || message.statusId.toString() === $scope.selectedStatus;
        const deletedMatch = $scope.showDeleted === undefined || message.isDeleted === ($scope.showDeleted === 'true');
        const brandMatch = !$scope.selectedBrand ||
            $scope.selectedBrand.id === 1 ||
            message.brandId === $scope.selectedBrand.id;

        const dateMatch = (!$scope.startDate || new Date(message.messageDate) >= new Date($scope.startDate)) &&
                         (!$scope.endDate || new Date(message.messageDate) <= new Date($scope.endDate));

        return loanMatch && queueMatch && categoryMatch && firstNameMatch && lastNameMatch && 
               statusMatch && deletedMatch && brandMatch && brandAccessible && dateMatch;
    });

    // Clear restriction message if more than one result or not searching by loan number
    if (!$scope.loanNumber || results.length !== 1) {
        $scope.restrictionMessage = '';
    }

    results.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));
    $scope.searchResults = results;
};
            $scope.searchLoans()
        });
    </script>
</body>

</html>