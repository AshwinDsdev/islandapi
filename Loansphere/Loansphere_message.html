<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoanSphere Messages</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --text-light: #ecf0f1;
            --background-color: #f5f6fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            color: var(--primary-color);
        }

        .wrapper {
            min-height: 100vh;
            background-color: white;
            box-shadow: var(--box-shadow);
        }

        .header2 {
            background-color: var(--primary-color);
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: var(--text-light);
        }

        .menu-hamburger {
            display: flex;
            align-items: center;
        }

        .hamburger-menu {
            color: var(--text-light);
            font-size: 1.5rem;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .hamburger-menu:hover {
            color: var(--accent-color);
        }

        .header-main-1 {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
        }

        .header-parts-client {
            color: var(--text-light);
        }

        .institution-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .content-wrapper {
            padding: 2rem;
            background-color: var(--background-color);
        }

        .searchgrid {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }

        .form-select,
        .form-control {
            display: block;
            width: 100%;
            height: 40px;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            margin: 8px 0;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-select:focus,
        .form-control:focus {
            border-color: var(--accent-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .info-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .material-icons {
            color: var(--accent-color);
            transition: transform 0.2s ease;
            font-size: 22px;
        }

        .material-icons:hover {
            transform: scale(1.1);
            color: #2980b9;
        }

        .ag-theme-material {
            --ag-header-height: 56px;
            --ag-header-background-color: #f8f9fa;
            --ag-header-foreground-color: var(--primary-color);
            --ag-header-cell-hover-background-color: #edf2f7;
            --ag-row-hover-color: #f1f5f9;
        }

        .ag-header-cell {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .ag-header-cell-text {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 14px;
        }

        .ag-row:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 1rem;
            }

            .searchgrid {
                padding: 1rem;
            }
        }

        .form-switch .form-check-input {
            width: 3em;
            cursor: pointer;
        }

        .form-switch .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .form-check-label {
            cursor: pointer;
        }
    </style>
    <!-- Add these in the head section after existing CSS links -->
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-material.css">
</head>

<body>
    <div id="loading-indicator" style="padding: 40px; display: none;">
        Loading...
    </div>
    <div class="wrapper">
        <header class="header2 d-flex flex-column flex-md-row align-items-center px-3 py-2">
            <div class="menu-hamburger">
                <i class="fas fa-bars hamburger-menu"></i>
                <span
                    style="color: whitesmoke; font-family: 'Suisse-SemiBold'; font-size: 1.5em; padding: 1px 0px 0px 24px;">
                    One Admin
                </span>
            </div>
            <div class="header-main-1 header-main-new ms-auto">
                <div class="header-parts-client py-2">
                    <div class="institution-name">Cenlar FSB</div>

                    <div class="form-group">
                        <select class="form-select" id="selectedLoan">
                            <option value="" disabled>Select Loan</option>
                            <!-- Loan options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-select" id="selectedChannel">
                            <!-- Channel options will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-select" id="selectedBrand">
                            <!-- Brand options will be populated by JavaScript -->
                        </select>
                    </div>
                </div>
            </div>
        </header>
        <main class="content-wrapper">
            <div class="container searchgrid">
                <div class="alert alert-warning" id="restrictionMessage" style="display: none;">
                    Loan is not provisioned to the user
                </div>
                <div class="info-section">
                    <i class="material-icons">info_outline</i>
                    <span class="info-text">How header filtering works</span>
                </div>
                <form id="searchForm" name="form" autocomplete="off">
                    <div class="flex-row-container flex-wrap">
                        <div class="form-group">
                            <label>Queue</label>
                            <select class="form-select" id="selectedQueue" multiple>
                                <!-- Queue options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select class="form-select" id="selectedCategory">
                                <option value="" disabled selected>Select Category</option>
                                <!-- Category options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" class="form-control" id="firstName" placeholder="Enter First Name">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" class="form-control" id="lastName" placeholder="Enter Last Name">
                        </div>
                        <div class="form-group">
                            <label>Loan Number</label>
                            <input type="text" class="form-control" id="loanNumber" placeholder="Enter Loan Number">
                        </div>
                        <div class="form-group">
                            <label>Show Deleted</label>
                            <select class="form-select" id="showDeleted">
                                <option value="">Select Option</option>
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" id="searchButton">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" id="refreshButton">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button type="button" class="btn btn-info ms-2" id="returnButton">
                                <i class="fas fa-arrow-left"></i> Return to Messages
                            </button>
                        </div>
                        <div class="form-group">
                            <div class="d-flex align-items-end">
                                <div class="flex-grow-1 me-2">
                                    <label>Select Loan to Remove</label>
                                    <select class="form-select" id="loanToRemove">
                                        <option value="" disabled selected>Choose loan to remove...</option>
                                        <!-- Loan options will be populated by JavaScript -->
                                    </select>
                                </div>
                                <button type="button" class="btn btn-danger" id="removeLoanButton" disabled>
                                    <i class="fas fa-trash-alt"></i> Remove Loan
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="container searchgrid">
                <div class="info-section">
                    <i class="material-icons">info_outline</i>
                    <span class="info-text">How column sorting and filtering works</span>
                </div>
                <div class="card">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Message Date</th>
                                    <th>Sender</th>
                                    <th>Message</th>
                                    <th>Queue</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Loan Number</th>
                                </tr>
                            </thead>
                            <tbody id="messageTableBody">
                                <!-- Message rows will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Bootstrap Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
    <script src="Brand_Ingestion.js" type="module"></script>
    <script src="Loan_Ingestion.js" type="module"></script>
    <script src="Message_Ingestion.js" type="module"></script>
    <script src="Queue_Ingestion.js" type="module"></script>
    <script src="filter_onshore_messages.js"></script>
    <script src="filter_onshore_loans.js"></script>
    <script src="filter_onshore_queues.js"></script>
    <script src="filter_onshore_brands.js"></script>


    <script>
        /**
         * LoanSphere Messages Management Module
         *
         * This module handles the message search, display, and management functionality.
         * It provides features for searching, filtering, and displaying message data
         * with proper handling of restricted loans and brands.
         */
        document.addEventListener('DOMContentLoaded', function () {
            // Global state
            let loans = [];
            let messages = [];
            let brands = [];
            let searchResults = [];
            let selectedBrand = null;
            let selectedChannel = null;
            let selectedLoan = null;
            let loanToRemove = null;

            // Define static data
            const queues = [
                {
                    id: 1,
                    name: "Default Queue",
                    type: "my",
                    sortOrder: 1,
                    brandIds: [1, 2, 3],
                    restricted: false
                },
                {
                    id: 2,
                    name: "High Priority",
                    type: "my",
                    sortOrder: 2,
                    brandIds: [2, 3],
                    restricted: false
                },
                {
                    id: 3,
                    name: "Customer Service",
                    type: "team",
                    sortOrder: 3,
                    brandIds: [1, 4],
                    restricted: false
                },
                {
                    id: 4,
                    name: "Technical Support",
                    type: "team",
                    sortOrder: 4,
                    brandIds: [3, 4, 5],
                    restricted: false
                },
                {
                    id: 5,
                    name: "Loan Processing",
                    type: "my",
                    sortOrder: 5,
                    brandIds: [1, 5],
                    restricted: false
                },
                {
                    id: 6,
                    name: "Underwriting",
                    type: "team",
                    sortOrder: 6,
                    brandIds: [2, 5, 6],
                    restricted: false
                },
                {
                    id: 7,
                    name: "Restricted Queue",
                    type: "my",
                    sortOrder: 7,
                    brandIds: [7, 8],
                    restricted: true
                },
                {
                    id: 8,
                    name: "Unrestricted Specific",
                    type: "my",
                    sortOrder: 8,
                    brandIds: [5, 6, 7, 8],
                    restricted: false
                }
            ];

            const categories = [
                { id: 1, CategoryName: "General Inquiry" },
                { id: 2, CategoryName: "Payment Issues" },
                { id: 3, CategoryName: "Loan Application" },
                { id: 4, CategoryName: "Technical Support" }
            ];

            const channels = [
                { id: 1, name: "Borrower Self-Service" },
                { id: 2, name: "Customer Portal" },
                { id: 3, name: "Mobile App" }
            ];

            const statuses = [
                { id: 1, StatusName: "Active" },
                { id: 2, StatusName: "Pending" },
                { id: 3, StatusName: "Completed" },
                { id: 4, StatusName: "On Hold" }
            ];

            /**
             * Wait for data to be available in the global scope with timeout
             * @param {string} dataKey - The key to check in the window object
             * @param {string} dataName - Human-readable name for logging
             * @param {Array} fallbackData - Data to use if loading fails
             * @param {number} maxAttempts - Maximum number of attempts before using fallback
             * @returns {Promise<Array>} The loaded data or fallback
             */
            async function waitForData(dataKey, dataName, fallbackData = [], maxAttempts = 5) {
                let attempts = 0;

                while (!window[dataKey] && attempts < maxAttempts) {
                    console.log(`Waiting for ${dataName} data... Attempt ${attempts + 1}/${maxAttempts}`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                }

                if (!window[dataKey]) {
                    console.warn(`Timed out waiting for ${dataName} data, using fallback data`);
                    return fallbackData;
                }

                console.log(`${dataName} data loaded successfully`);
                return window[dataKey];
            }

            /**
             * Load loans data
             * @returns {Promise<Array>} Loans data
             */
            async function loadLoans() {
                const loansData = await waitForData('storedLoansSet', 'loans', []);

                // Process the loan data to add isRestricted property
                // For offshore users, loans with type "onshore" are restricted
                return loansData.map(loan => ({
                    ...loan,
                    restricted: loan.type === "onshore"
                }));
            }

            /**
             * Load messages data
             * @returns {Promise<Array>} Messages data
             */
            async function loadMessages() {
                const messagesData = await waitForData('storedMessagesSet', 'messages', []);

                // Process message data - modified to never mark messages as restricted
                return messagesData.map(message => ({
                    ...message,
                    isRestricted: false // Never mark messages as restricted
                }));
            }

            /**
             * Load brands data
             * @returns {Promise<Array>} Brands data
             */
            async function loadBrands() {
                const fallbackBrands = [
                    {
                        id: 5,
                        name: "Bank of America",
                        value: "bankofamerica",
                        type: "offshore",
                        restricted: false
                    },
                    {
                        id: 6,
                        name: "Citibank",
                        value: "citibank",
                        type: "offshore",
                        restricted: false
                    }
                ];

                const brandsData = await waitForData('storedNumbersSet', 'brands', fallbackBrands);

                return brandsData.map(brand => ({
                    id: brand.id,
                    name: brand.name,
                    value: brand.value,
                    type: brand.type,
                    restricted: brand.restricted
                }));
            }

            /**
             * Check if a loan is accessible - modified to show all loans
             * @param {Object} loan - The loan to check
             * @returns {boolean} Always returns true for valid loans
             */
            function isLoanAccessible(loan) {
                return loan !== null && loan !== undefined; // Show all loans regardless of restrictions
            }

            /**
             * Check if a message is accessible - modified to show all messages
             * @param {Object} message - The message to check
             * @returns {boolean} Always returns true to show all messages
             */
            function isMessageAccessible(message) {
                if (!message) return false;

                // Get the associated loan and brand (for reference only)
                const loan = loans.find(l => l.id === message.loanId);
                const brand = brands.find(b => b.id === message.brandId);

                // Modified to show all messages regardless of restrictions
                // This ensures all data is displayed (onshore + offshore)
                return true;
            }

            /**
             * Get accessible loans for offshore users
             * @returns {Array} Accessible loans
             */
            function getAccessibleLoans() {
                return loans.filter(loan => isLoanAccessible(loan));
            }

            /**
             * Get accessible brands - modified to show all brands
             * @returns {Array} All brands regardless of restrictions
             */
            function getAccessibleBrands() {
                return brands; // Return all brands without filtering
            }

            /**
             * Check if a queue should be visible - modified to show all queues
             * @param {Object} queue - The queue to check
             * @returns {boolean} Always returns true to show all queues
             */
            function isQueueVisibleToUser(queue) {
                return true; // Show all queues regardless of restrictions
            }

            /**
             * Get the name of a queue by ID
             * @param {number} queueId - The queue ID
             * @returns {string} The queue name
             */
            function getQueueName(queueId) {
                const queue = queues.find(q => q.id === parseInt(queueId));
                return queue ? queue.name : '';
            }

            /**
             * Get the name of a category by ID
             * @param {number} categoryId - The category ID
             * @returns {string} The category name
             */
            function getCategoryName(categoryId) {
                const category = categories.find(c => c.id === parseInt(categoryId));
                return category ? category.CategoryName : '';
            }

            /**
             * Get the name of a status by ID
             * @param {number} statusId - The status ID
             * @returns {string} The status name
             */
            function getStatusName(statusId) {
                const status = statuses.find(s => s.id === parseInt(statusId));
                return status ? status.StatusName : '';
            }

            /**
             * Get the loan number by loan ID
             * @param {number} loanId - The loan ID
             * @returns {string} The loan number
             */
            function getLoanNumber(loanId) {
                const loan = loans.find(l => l.id === loanId);
                return loan ? loan.loanNumber : '';
            }

            /**
             * Check if a message matches all search criteria
             * @param {Object} message - The message to check
             * @param {Object} criteria - Search criteria
             * @returns {boolean} True if the message matches all criteria
             */
            function messageMatchesSearchCriteria(message, criteria) {
                const loan = loans.find(l => l.id === message.loanId);
                if (!loan) return false;

                // Apply all search filters
                // For loan number, we want to match exactly or as a substring
                const loanMatch = !criteria.loanNumber || (
                    loan.loanNumber && (
                        // Exact match (case insensitive)
                        loan.loanNumber.toString().toLowerCase() === criteria.loanNumber.toLowerCase() ||
                        // Contains match (for partial searches)
                        loan.loanNumber.toString().toLowerCase().includes(criteria.loanNumber.toLowerCase())
                    )
                );

                const queueMatch = !criteria.selectedQueue || criteria.selectedQueue.length === 0 ||
                    (message.queueId && criteria.selectedQueue.includes(message.queueId.toString()));

                const categoryMatch = !criteria.selectedCategory ||
                    (message.categoryId && message.categoryId.toString() === criteria.selectedCategory);

                const firstNameMatch = !criteria.firstName ||
                    (loan.borrowerName && loan.borrowerName.toLowerCase().includes((criteria.firstName || '').toLowerCase()));

                const lastNameMatch = !criteria.lastName ||
                    (loan.borrowerName && loan.borrowerName.toLowerCase().includes((criteria.lastName || '').toLowerCase()));

                const statusMatch = !criteria.selectedStatus ||
                    (message.statusId && message.statusId.toString() === criteria.selectedStatus);

                const deletedMatch = criteria.showDeleted === undefined || criteria.showDeleted === "" ||
                    message.isDeleted === (criteria.showDeleted === 'true');

                // Apply brand filter if a brand is selected
                const brandMatch = !criteria.selectedBrand ||
                    (message.brandId && message.brandId === criteria.selectedBrand.id);

                const dateMatch = (!criteria.startDate || new Date(message.messageDate) >= new Date(criteria.startDate)) &&
                    (!criteria.endDate || new Date(message.messageDate) <= new Date(criteria.endDate));

                return loanMatch && queueMatch && categoryMatch && firstNameMatch && lastNameMatch &&
                    statusMatch && deletedMatch && brandMatch && dateMatch;
            }

            /**
             * Filter queues based on type and visibility
             * @param {string} filter - Filter type ('all', 'my', 'team')
             * @returns {Array} Filtered queues
             */
            function filterQueues(filter) {
                // First filter by queue type
                let filteredQueues = queues;
                if (filter !== 'all') {
                    filteredQueues = queues.filter(queue => queue.type === filter);
                }

                // Then filter by visibility
                filteredQueues = filteredQueues.filter(queue => isQueueVisibleToUser(queue));

                // Then filter by selected brand if any
                if (selectedBrand) {
                    filteredQueues = filteredQueues.filter(queue =>
                        queue.brandIds && queue.brandIds.includes(selectedBrand.id)
                    );
                }

                // Sort by the original sort order
                return filteredQueues.sort((a, b) => a.sortOrder - b.sortOrder);
            }

            /**
             * Populate the UI with data
             */
            function populateUI() {
                // Populate loan dropdown
                const loanSelect = document.getElementById('selectedLoan');
                loanSelect.innerHTML = '<option value="" disabled selected>Select Loan</option>';

                const accessibleLoans = getAccessibleLoans();
                accessibleLoans.forEach(loan => {
                    const option = document.createElement('option');
                    option.value = loan.id;
                    option.textContent = `${loan.loanNumber} - ${loan.propertyInfo || ''}`;
                    loanSelect.appendChild(option);
                });

                // Populate channel dropdown
                const channelSelect = document.getElementById('selectedChannel');
                channelSelect.innerHTML = '';

                channels.forEach(channel => {
                    const option = document.createElement('option');
                    option.value = channel.id;
                    option.textContent = channel.name;
                    channelSelect.appendChild(option);
                });

                // Populate brand dropdown
                const brandSelect = document.getElementById('selectedBrand');
                brandSelect.innerHTML = '';

                const accessibleBrands = getAccessibleBrands();
                accessibleBrands.forEach(brand => {
                    const option = document.createElement('option');
                    option.value = brand.id;
                    option.textContent = brand.name;
                    brandSelect.appendChild(option);
                });

                // Populate queue dropdown
                const queueSelect = document.getElementById('selectedQueue');
                queueSelect.innerHTML = '';

                const visibleQueues = queues.filter(queue => isQueueVisibleToUser(queue));
                visibleQueues.forEach(queue => {
                    const option = document.createElement('option');
                    option.value = queue.id;
                    option.textContent = queue.name;
                    queueSelect.appendChild(option);
                });

                // Populate category dropdown
                const categorySelect = document.getElementById('selectedCategory');
                categorySelect.innerHTML = '<option value="" disabled selected>Select Category</option>';

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.CategoryName;
                    categorySelect.appendChild(option);
                });

                // Populate loan to remove dropdown
                const loanToRemoveSelect = document.getElementById('loanToRemove');
                loanToRemoveSelect.innerHTML = '<option value="" disabled selected>Choose loan to remove...</option>';

                accessibleLoans.forEach(loan => {
                    const option = document.createElement('option');
                    option.value = loan.id;
                    option.textContent = `${loan.loanNumber} - ${loan.propertyInfo || ''}`;
                    loanToRemoveSelect.appendChild(option);
                });

                // Set default values
                if (accessibleBrands.length > 0) {
                    selectedBrand = accessibleBrands[0];
                    brandSelect.value = selectedBrand.id;
                }

                if (channels.length > 0) {
                    selectedChannel = channels[0];
                    channelSelect.value = selectedChannel.id;
                }
            }

            /**
             * Update the message table with search results
             */
            function updateMessageTable() {
                const tableBody = document.getElementById('messageTableBody');
                tableBody.innerHTML = '';

                if (searchResults.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="7" class="text-center">
                            <div class="alert alert-info">
                                No matching records found
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(tr);
                    return;
                }

                searchResults.forEach(message => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${message.messageDate}</td>
                        <td>${message.sender}</td>
                        <td>${message.messageText}</td>
                        <td>${getQueueName(message.queueId)}</td>
                        <td>${getCategoryName(message.categoryId)}</td>
                        <td>${getStatusName(message.statusId)}</td>
                        <td>${getLoanNumber(message.loanId)}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            }

            /**
             * Search messages based on form criteria
             */
            function searchMessages() {
                // Show loading indicator
                document.getElementById('loading-indicator').style.display = 'block';

                // Hide restriction message
                document.getElementById('restrictionMessage').style.display = 'none';

                // Get search criteria from form
                const criteria = {
                    loanNumber: document.getElementById('loanNumber').value.trim(),
                    selectedQueue: Array.from(document.getElementById('selectedQueue').selectedOptions).map(option => option.value),
                    selectedCategory: document.getElementById('selectedCategory').value,
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    showDeleted: document.getElementById('showDeleted').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    selectedBrand: selectedBrand
                };

                // Special case: Check if searching for a restricted loan number
                if (criteria.loanNumber) {
                    // First, check for exact match with a restricted loan
                    const exactRestrictedLoan = loans.find(loan =>
                        loan.loanNumber &&
                        loan.loanNumber.toString().toLowerCase() === criteria.loanNumber.toLowerCase() &&
                        loan.restricted
                    );

                    // If an exact match with a restricted loan is found, show restriction message
                    if (exactRestrictedLoan) {
                        document.getElementById('restrictionMessage').style.display = 'block';
                        document.getElementById('loading-indicator').style.display = 'none';
                        searchResults = [];
                        updateMessageTable();
                        return;
                    }

                    // Also check for partial matches with restricted loans
                    const partialRestrictedLoans = loans.filter(loan =>
                        loan.loanNumber &&
                        loan.loanNumber.toString().toLowerCase().includes(criteria.loanNumber.toLowerCase()) &&
                        loan.restricted
                    );

                    // If there's only one partial match and it's restricted, show restriction message
                    if (partialRestrictedLoans.length === 1) {
                        document.getElementById('restrictionMessage').style.display = 'block';
                        document.getElementById('loading-indicator').style.display = 'none';
                        searchResults = [];
                        updateMessageTable();
                        return;
                    }
                }

                // Step 1: Get all messages that match the search criteria
                let filteredMessages = messages.filter(message => {
                    // First check if the message is associated with a restricted loan
                    const loan = loans.find(l => l.id === message.loanId);

                    // If searching by loan number and this message's loan matches but is restricted,
                    // we'll collect it to show the restriction message later
                    if (criteria.loanNumber && loan && loan.restricted &&
                        loan.loanNumber && loan.loanNumber.toString().toLowerCase().includes(criteria.loanNumber.toLowerCase())) {
                        return true; // Include restricted loans in initial filtering
                    }

                    // Otherwise, apply normal search criteria
                    return messageMatchesSearchCriteria(message, criteria);
                });

                // Step 2: Requirement 1 - If search on specific fields results in exactly one record
                // that is restricted, show "Loan is not provisioned to the user" message
                const isSearchingBySpecificFields = criteria.loanNumber ||
                    criteria.selectedQueue.length > 0 ||
                    criteria.selectedCategory ||
                    criteria.firstName ||
                    criteria.lastName ||
                    criteria.showDeleted ||
                    criteria.startDate ||
                    criteria.endDate;

                // Modified to never show restriction message and always show all messages
                // No need to check for restricted messages anymore

                // Always hide the restriction message
                document.getElementById('restrictionMessage').style.display = 'none';

                // Step 3: Modified to show all messages regardless of restrictions
                // Show all data (onshore + offshore)
                let accessibleMessages = filteredMessages; // No filtering - show all messages

                // Step 4: Requirement 4 - Maintain default sort order when excluding restricted records
                accessibleMessages.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));

                // Step 5: Requirement 5 - If a Brand is selected, limit results by the selected Brand
                if (selectedBrand) {
                    accessibleMessages = accessibleMessages.filter(message =>
                        message.brandId === selectedBrand.id
                    );
                }

                // Hide loading indicator
                document.getElementById('loading-indicator').style.display = 'none';

                // Update search results and table
                searchResults = accessibleMessages;
                updateMessageTable();
            }

            /**
             * Refresh results
             * Resets filters and shows only accessible messages
             * Requirement 6: Selecting refresh should continue to not show restricted records
             */
            function refreshResults() {
                // Reset search form
                document.getElementById('searchForm').reset();

                // Hide restriction message
                document.getElementById('restrictionMessage').style.display = 'none';

                // Show all messages regardless of restrictions
                // Modified to show all data (onshore + offshore)
                let accessibleMessages = messages.filter(message => {
                    // Get the associated loan and brand for reference only
                    const loan = loans.find(l => l.id === message.loanId);
                    const brand = brands.find(b => b.id === message.brandId);

                    // Return true for all messages to show everything
                    return true; // Modified to show all data (onshore + offshore)
                });

                // Apply brand filter if a brand is selected
                // This ensures requirement 5 is met - limit results by selected Brand
                if (selectedBrand) {
                    accessibleMessages = accessibleMessages.filter(message =>
                        message.brandId === selectedBrand.id
                    );
                }

                // Maintain default sort order
                // This ensures requirement 4 is met - maintain default sort order
                accessibleMessages.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));

                // Update search results and table
                searchResults = accessibleMessages;
                updateMessageTable();
            }

            /**
             * Return to messages list
             * Resets filters and shows only accessible messages
             * User Story 2: When returning to Messages page, display only records available to the user
             */
            function returnToMessages() {
                // Reset search form
                document.getElementById('searchForm').reset();

                // Hide restriction message
                document.getElementById('restrictionMessage').style.display = 'none';

                // Show all messages regardless of restrictions
                // Modified to show all data (onshore + offshore)
                let accessibleMessages = messages.filter(message => {
                    // Get the associated loan and brand for reference only
                    const loan = loans.find(l => l.id === message.loanId);
                    const brand = brands.find(b => b.id === message.brandId);

                    // Return true for all messages to show everything
                    return true; // Modified to show all data (onshore + offshore)
                });

                // Apply brand filter if a brand is selected
                if (selectedBrand) {
                    accessibleMessages = accessibleMessages.filter(message =>
                        message.brandId === selectedBrand.id
                    );
                }

                // Sort by date (maintaining default sort order)
                accessibleMessages.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));

                // Update search results and table
                searchResults = accessibleMessages;
                updateMessageTable();
            }

            /**
             * Remove a loan
             */
            function removeLoan() {
                const loanId = document.getElementById('loanToRemove').value;
                if (!loanId) return;

                // Find the loan in the loans array
                const loanIndex = loans.findIndex(l => l.id.toString() === loanId.toString());
                if (loanIndex === -1) return;

                // Remove the loan from the array
                loans.splice(loanIndex, 1);

                // Reset the loanToRemove dropdown
                document.getElementById('loanToRemove').value = '';

                // Disable the remove button
                document.getElementById('removeLoanButton').disabled = true;

                // Update the UI
                populateUI();
                searchMessages();
            }

            /**
             * Initialize the application
             */
            async function initialize() {
                try {
                    // Show loading indicator
                    document.getElementById('loading-indicator').style.display = 'block';

                    // Load all data in parallel
                    [loans, messages, brands] = await Promise.all([
                        loadLoans(),
                        loadMessages(),
                        loadBrands()
                    ]);

                    // Populate UI with data
                    populateUI();

                    // Set up event listeners
                    document.getElementById('searchButton').addEventListener('click', searchMessages);
                    document.getElementById('refreshButton').addEventListener('click', refreshResults);
                    document.getElementById('returnButton').addEventListener('click', returnToMessages);
                    document.getElementById('removeLoanButton').addEventListener('click', removeLoan);

                    // Handle brand selection
                    document.getElementById('selectedBrand').addEventListener('change', function () {
                        const brandId = this.value;
                        selectedBrand = brands.find(b => b.id.toString() === brandId);
                    });

                    // Handle channel selection
                    document.getElementById('selectedChannel').addEventListener('change', function () {
                        const channelId = this.value;
                        selectedChannel = channels.find(c => c.id.toString() === channelId);
                    });

                    // Handle loan selection
                    document.getElementById('selectedLoan').addEventListener('change', function () {
                        const loanId = this.value;
                        selectedLoan = loans.find(l => l.id.toString() === loanId);
                    });

                    // Handle loan to remove selection
                    document.getElementById('loanToRemove').addEventListener('change', function () {
                        document.getElementById('removeLoanButton').disabled = !this.value;
                    });

                    // Initial refresh to show data
                    refreshResults();

                    // Hide loading indicator
                    document.getElementById('loading-indicator').style.display = 'none';
                } catch (error) {
                    console.error("Error initializing application:", error);
                    document.getElementById('loading-indicator').style.display = 'none';
                }
            }

            // Initialize the application
            initialize();
        });
    </script>
</body>

</html>