<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoanSphere Messages</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- AngularJS and Angular Material -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.2.5/angular-material.min.js"></script>
    <link href="https://ajax.googleapis.com/ajax/libs/angular_material/1.2.5/angular-material.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-aria.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-animate.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --text-light: #ecf0f1;
            --background-color: #f5f6fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            color: var(--primary-color);
        }

        .wrapper {
            min-height: 100vh;
            background-color: white;
            box-shadow: var(--box-shadow);
        }

        .header2 {
            background-color: var(--primary-color);
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: var(--text-light);
        }

        .menu-hamburger {
            display: flex;
            align-items: center;
        }

        .hamburger-menu {
            color: var(--text-light);
            font-size: 1.5rem;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .hamburger-menu:hover {
            color: var(--accent-color);
        }

        .header-main-1 {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
        }

        .header-parts-client {
            color: var(--text-light);
        }

        .institution-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .content-wrapper {
            padding: 2rem;
            background-color: var(--background-color);
        }

        .searchgrid {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }

        .form-select,
        .form-control {
            display: block;
            width: 100%;
            height: 40px;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            margin: 8px 0;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-select:focus,
        .form-control:focus {
            border-color: var(--accent-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .info-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .material-icons {
            color: var(--accent-color);
            transition: transform 0.2s ease;
            font-size: 22px;
        }

        .material-icons:hover {
            transform: scale(1.1);
            color: #2980b9;
        }

        .ag-theme-material {
            --ag-header-height: 56px;
            --ag-header-background-color: #f8f9fa;
            --ag-header-foreground-color: var(--primary-color);
            --ag-header-cell-hover-background-color: #edf2f7;
            --ag-row-hover-color: #f1f5f9;
        }

        .ag-header-cell {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .ag-header-cell-text {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 14px;
        }

        .ag-row:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 1rem;
            }

            .searchgrid {
                padding: 1rem;
            }
        }

        .form-switch .form-check-input {
            width: 3em;
            cursor: pointer;
        }

        .form-switch .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .form-check-label {
            cursor: pointer;
        }
    </style>
    <!-- Add these in the head section after existing CSS links -->
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-material.css">
</head>

<body ng-app="loanApp" ng-controller="LoanController">
    <div id="loading-indicator" style="padding: 40px; display: none;">
        Loading...
    </div>
    <div class="wrapper">
        <header class="header2 d-flex flex-column flex-md-row align-items-center px-3 py-2">
            <div class="menu-hamburger">
                <i class="fas fa-bars hamburger-menu"></i>
                <span
                    style="color: whitesmoke; font-family: 'Suisse-SemiBold'; font-size: 1.5em; padding: 1px 0px 0px 24px;">
                    One Admin
                </span>
            </div>
            <div class="header-main-1 header-main-new ms-auto">
                <div class="header-parts-client py-2">
                    <div class="institution-name ng-star-inserted">Cenlar FSB</div>
                    <div class="form-group d-flex align-items-center">
                        <label class="me-3 text-light">User Type:</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="userTypeSwitch" ng-model="isOffshore"
                                ng-change="updateUserType()">
                            <label class="form-check-label text-light" for="userTypeSwitch">{{isOffshore ? 'Offshore' :
                                'Onshore'}}</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <select class="form-select" ng-model="selectedLoan">
                            <option value="" disabled>Select Loan</option>
                            <option ng-repeat="loan in getAccessibleLoans()" value="{{loan.id}}">
                                {{loan.loanNumber}} - {{loan.propertyInfo}}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-select" ng-model="selectedChannel">
                            <option ng-repeat="channel in channels" value="{{channel.id}}">{{channel.name}}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-select" ng-model="selectedBrand">
                            <option ng-repeat="brand in getAccessibleBrands()" ng-value="brand">{{brand.name}}</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>
        <main class="content-wrapper">
            <div class="container searchgrid">
                <div class="alert alert-warning" ng-if="restrictionMessage">
                    {{ restrictionMessage }}
                </div>
                <div class="info-section">
                    <i class="material-icons">info_outline</i>
                    <span class="info-text">How header filtering works</span>
                </div>
                <form novalidate="" name="form" autocomplete="off" class="ng-untouched ng-pristine ng-valid">
                    <div class="flex-row-container flex-wrap">
                        <div class="form-group">
                            <label>Queue</label>
                            <select class="form-select" ng-model="selectedQueue" multiple
                                aria-describedby="cdk-describedby-message-ng-1-10">
                                <option ng-repeat="queue in queues" value="{{queue.id}}">{{queue.Value}}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select class="form-select" ng-model="selectedCategory"
                                aria-describedby="cdk-describedby-message-ng-1-11">
                                <option value="" disabled>Select Category</option>
                                <option ng-repeat="category in categories" value="{{category.id}}">
                                    {{category.CategoryName}}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" class="form-control" ng-model="firstName" placeholder="Enter First Name"
                                aria-describedby="cdk-describedby-message-ng-1-12">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" class="form-control" ng-model="lastName" placeholder="Enter Last Name"
                                aria-describedby="cdk-describedby-message-ng-1-13">
                        </div>
                        <div class="form-group">
                            <label>Loan Number</label>
                            <input type="text" class="form-control" ng-model="loanNumber"
                                placeholder="Enter Loan Number" aria-describedby="cdk-describedby-message-ng-1-14">
                        </div>
                        <div class="form-group">
                            <label>Show Deleted</label>
                            <select class="form-select" ng-model="showDeleted"
                                aria-describedby="cdk-describedby-message-ng-1-16">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" class="form-control" ng-model="startDate"
                                aria-describedby="cdk-describedby-message-ng-1-17">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" class="form-control" ng-model="endDate"
                                aria-describedby="cdk-describedby-message-ng-1-18">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" ng-click="searchLoans()">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button class="btn btn-secondary ms-2" ng-click="refreshResults()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="btn btn-info ms-2" ng-click="returnToMessages()">
                                <i class="fas fa-arrow-left"></i> Return to Messages
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger" ng-repeat="loan in getAccessibleLoans()"
                                ng-click="removeLoan(loan.id)" ng-if="canRemoveLoan(loan.id)"
                                style="margin-right: 10px;">
                                Remove {{loan.loanNumber}}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="container searchgrid">
                <div class="info-section">
                    <i class="material-icons">info_outline</i>
                    <span class="info-text">How column sorting and filtering works</span>
                </div>
                <mat-card appearance="outlined"
                    class="mat-mdc-card mdc-card p-0 mat-mdc-card-outlined mdc-card--outlined">
                    <!-- Replace the ag-grid div with this table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Message Date</th>
                                    <th>Sender</th>
                                    <th>Message</th>
                                    <th>Queue</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Loan Number</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="message in searchResults">
                                    <td>{{message.messageDate}}</td>
                                    <td>{{message.sender}}</td>
                                    <td>{{message.messageText}}</td>
                                    <td>{{getQueueName(message.queueId)}}</td>
                                    <td>{{getCategoryName(message.categoryId)}}</td>
                                    <td>{{getStatusName(message.statusId)}}</td>
                                    <td>{{getLoanNumber(message.loanId)}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </mat-card>
            </div>
        </main>
    </div>

    <div class="cdk-live-announcer-element cdk-visually-hidden" aria-atomic="true" aria-live="polite"
        id="cdk-live-announcer-0"></div>
    <div class="cdk-overlay-container"></div>
    <div class="cdk-describedby-message-container cdk-visually-hidden" style="visibility: hidden;">
        <div id="cdk-describedby-message-ng-1-8" role="tooltip">Help Center</div>
        <div id="cdk-describedby-message-ng-1-9" role="tooltip">User Profile Menu</div>
        <div id="cdk-describedby-message-ng-1-10" role="tooltip">Show Message Threads in selected Queue(s)</div>
        <div id="cdk-describedby-message-ng-1-11" role="tooltip">Show Message Threads in selected Category</div>
        <div id="cdk-describedby-message-ng-1-12" role="tooltip">Show Message Threads from Borrower(s) with specified
            First Name</div>
        <div id="cdk-describedby-message-ng-1-13" role="tooltip">Show Message Threads from Borrower(s) with specified
            Last Name</div>
        <div id="cdk-describedby-message-ng-1-14" role="tooltip">Show Message Threads from Borrower(s) with specified
            Loan Number</div>
        <div id="cdk-describedby-message-ng-1-15" role="tooltip">Show Message Threads with selected Status</div>
        <div id="cdk-describedby-message-ng-1-16" role="tooltip">Show Message Threads that Borrowers have Deleted</div>
        <div id="cdk-describedby-message-ng-1-17" role="tooltip">Show Message Threads with Borrower Message Date on or
            after selected date</div>
        <div id="cdk-describedby-message-ng-1-18" role="tooltip">Show Message Threads with Borrower Message Date on or
            before selected date</div>
        <div id="cdk-describedby-message-ng-1-19" role="tooltip">Filtering applies to all message threads and search
            results are sorted by Borrower Message Date.</div>
        <div id="cdk-describedby-message-ng-1-20" role="tooltip">Sorting/filtering applies only to the current search
            results page.</div>
    </div>

    <!-- Bootstrap and AngularJS Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
    <script src="Brand_Ingestion.js" type="module"></script>
    <script src="Loan_Ingestion.js" type="module"></script>
    <script src="Message_Ingestion.js" type="module"></script>

    <script>
        var app = angular.module('loanApp', ['ngMaterial', 'ngAria', 'ngAnimate']);

        async function waitForLoans() {
            // Try to wait for up to 5 seconds for the loans data
            let attempts = 0;
            const maxAttempts = 5;

            while (!window.storedLoansSet && attempts < maxAttempts) {
                console.log(`Waiting for loans data... Attempt ${attempts + 1}/${maxAttempts}`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for 1 second
                attempts++;
            }

            if (!window.storedLoansSet) {
                console.warn("Timed out waiting for loans data, using fallback data");
                // Return fallback data if window.storedLoansSet is still not available
                return [

                ];
            }

            console.log("Loans data loaded successfully");
            return window.storedLoansSet;
        }


        async function waitForMessages() {
            // Try to wait for up to 5 seconds for the loans data
            let attempts = 0;
            const maxAttempts = 5;

            while (!window.storedMessagesSet && attempts < maxAttempts) {
                console.log(`Waiting for loans data... Attempt ${attempts + 1}/${maxAttempts}`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for 1 second
                attempts++;
            }

            if (!window.storedMessagesSet) {
                console.warn("Timed out waiting for loans data, using fallback data");
                // Return fallback data if window.storedLoansSet is still not available
                return [

                ];
            }

            console.log("storedMessagesSet data loaded successfully");
            return window.storedMessagesSet;
        }

        async function waitForBrands() {
            // Try to wait for up to 5 seconds for the brands data
            let attempts = 0;
            const maxAttempts = 5;

            while (!window.storedNumbersSet && attempts < maxAttempts) {
                console.log(`Waiting for brands data... Attempt ${attempts + 1}/${maxAttempts}`);
                await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for 1 second
                attempts++;
            }

            if (!window.storedNumbersSet) {
                console.warn("Timed out waiting for brands data, using fallback data");
                // Return fallback data if window.storedNumbersSet is still not available
                return [
                    // Fallback offshore brands data with new structure
                    {
                        id: 5,
                        name: "Bank of America",
                        value: "bankofamerica",
                        type: "offshore",
                        restricted: false
                    },
                    {
                        id: 6,
                        name: "Citibank",
                        value: "citibank",
                        type: "offshore",
                        restricted: false
                    }
                ];
            }

            console.log("Brands data loaded successfully");
            return window.storedNumbersSet;
        }

        app.controller('LoanController', async function ($scope, $timeout) {
            $scope.loans = [];

            try {
                const loansData = await waitForLoans();
                console.log("Loans Set:", loansData);
                $scope.loans = loansData || [];

                // If no loans data was loaded, use fallback sample data
                if (!$scope.loans || $scope.loans.length === 0) {
                    console.log("Using fallback loan data");
                }

                // Use $timeout to ensure Angular digest cycle is triggered
                $timeout(function () {
                    $scope.searchLoans();
                });
            } catch (error) {
                console.error("Error loading loans data:", error);

                // Use $timeout to ensure Angular digest cycle is triggered
                $timeout(function () {
                    $scope.searchLoans();
                });
            }


            $scope.getLoanNumber = function (loanId) {
                const loan = $scope.loans.find(l => l.id === loanId);
                return loan ? loan.loanNumber : '';
            };

            $scope.messages = [

            ];

            try {
                const messagesData = await waitForMessages();
                console.log("Loans Set:", messagesData);
                $scope.messages = messagesData || [];

                // If no loans data was loaded, use fallback sample data
                if (!$scope.messages || $scope.messages.length === 0) {
                    console.log("Using fallback loan data");
                }


            } catch (error) {
                console.error("Error loading loans data:", error);


            }

            $scope.brands = [];

            try {
                const brandsData = await waitForBrands();
                console.log("Brands data:", brandsData);

                // Process the new brand structure
                $scope.brands = brandsData.map(brand => ({
                    id: brand.id,
                    name: brand.name,
                    value: brand.value,
                    type: brand.type,
                    restricted: brand.restricted
                }));

                // If no brands data was loaded, use fallback sample data
                if (!$scope.brands || $scope.brands.length === 0) {
                    console.log("Using fallback brands data");
                    $scope.brands = [
                        {
                            id: 5,
                            name: "Bank of America",
                            value: "bankofamerica",
                            type: "offshore",
                            restricted: false
                        },
                        {
                            id: 6,
                            name: "Citibank",
                            value: "citibank",
                            type: "offshore",
                            restricted: false
                        }
                    ];
                }
            } catch (error) {
                console.error("Error loading brands data:", error);
                // Set fallback data in case of error
                $scope.brands = [
                    {
                        id: 5,
                        name: "Bank of America",
                        value: "bankofamerica",
                        type: "offshore",
                        restricted: false
                    },
                    {
                        id: 6,
                        name: "Citibank",
                        value: "citibank",
                        type: "offshore",
                        restricted: false
                    }
                ];
            }


            // Dummy data
            $scope.queues = [
                { id: 1, Value: "Default Queue" },
                { id: 2, Value: "High Priority" },
                { id: 3, Value: "Customer Service" },
                { id: 4, Value: "Technical Support" }
            ];

            $scope.categories = [
                { id: 1, CategoryName: "General Inquiry" },
                { id: 2, CategoryName: "Payment Issues" },
                { id: 3, CategoryName: "Loan Application" },
                { id: 4, CategoryName: "Technical Support" }
            ];

            $scope.channels = [
                { id: 1, name: "Borrower Self-Service" },
                { id: 2, name: "Customer Portal" },
                { id: 3, name: "Mobile App" }
            ];

            $scope.statuses = [
                { id: 1, StatusName: "Active" },
                { id: 2, StatusName: "Pending" },
                { id: 3, StatusName: "Completed" },
                { id: 4, StatusName: "On Hold" }
            ];
            $scope.getQueueName = function (queueId) {
                const queue = $scope.queues.find(q => q.id === parseInt(queueId));
                return queue ? queue.Value : '';
            };

            $scope.returnToMessages = function () {
                // Reset filters
                $scope.selectedQueue = [];
                $scope.selectedCategory = null;
                $scope.selectedStatus = null;
                $scope.startDate = null;
                $scope.endDate = null;
                $scope.selectedLoan = null;
                $scope.restrictionMessage = ''; // Clear any restriction messages

                // Note: Since we're only getting offshore data from the API,
                // we don't need to filter by user type anymore
                $scope.searchResults = $scope.messages;

                // Sort by date (maintaining default sort order)
                $scope.searchResults.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));
            };

            $scope.getCategoryName = function (categoryId) {
                const category = $scope.categories.find(c => c.id === parseInt(categoryId));
                return category ? category.CategoryName : '';
            };

            $scope.getAccessibleBrands = function () {
                // For onshore users, return all brands
                if ($scope.userType === 'onshore') {
                    return $scope.brands;
                }
                // For offshore users, only return brands with type 'offshore' and not restricted
                return $scope.brands.filter(brand =>
                    brand.type === 'offshore' && !brand.restricted
                );
            };

            $scope.getStatusName = function (statusId) {
                const status = $scope.statuses.find(s => s.id === parseInt(statusId));
                return status ? status.StatusName : '';
            };

            $scope.selectedQueue = [];
            $scope.selectedCategory = null;
            $scope.selectedChannel = $scope.channels[0];
            $scope.selectedBrand = null; // Initialize as null and set after brands are loaded
            $scope.selectedStatus = null;
            $scope.isOffshore = false;
            $scope.userType = 'onshore';

            // Set default brand after brands are loaded
            $timeout(function() {
                if ($scope.brands && $scope.brands.length > 0) {
                    $scope.selectedBrand = $scope.brands[0];
                }
            }, 500);

            $scope.updateUserType = function () {
                $scope.userType = $scope.isOffshore ? 'offshore' : 'onshore';
                $scope.selectedLoan = null;

                if ($scope.isOffshore) {
                    $scope.searchResults = $scope.messages.filter(message => message.allowedUserTypes.includes('offshore'));
                } else {
                    $scope.searchLoans();
                }
            };


            $scope.getAccessibleLoans = function () {
                if ($scope.userType === 'onshore') {
                    return $scope.loans; // Onshore users can access all loans
                }
                // Offshore users can only access unrestricted loans
                return $scope.loans.filter(loan => loan.allowedUserTypes.includes('offshore'));
            };

            $scope.canRemoveLoan = function (loanId) {
                const loan = $scope.loans.find(l => l.id === loanId);
                if (!loan) return false;

                // Only allow removal if the loan is non-restricted (accessible to both user types)
                return loan.types.includes('onshore') && loan.types.includes('offshore');
            };
            $scope.selectedLoan = null;


            $scope.restrictionMessage = '';

            $scope.gridOptions = {
                columnDefs: [
                    { field: 'loanNumber', headerName: 'Loan Number', sortable: true, filter: true },
                    { field: 'borrowerName', headerName: 'Borrower Name', sortable: true, filter: true },
                    { field: 'propertyInfo', headerName: 'Property Info', sortable: true, filter: true },
                    {
                        field: 'queueId',
                        headerName: 'Queue',
                        sortable: true,
                        filter: true,
                        valueGetter: function (params) {
                            const queue = $scope.queues.find(q => q.id === parseInt(params.data.queueId));
                            return queue ? queue.Value : '';
                        }
                    },
                    {
                        field: 'categoryId',
                        headerName: 'Category',
                        sortable: true,
                        filter: true,
                        valueGetter: function (params) {
                            const category = $scope.categories.find(c => c.id === parseInt(params.data.categoryId));
                            return category ? category.CategoryName : '';
                        }
                    },
                    {
                        field: 'statusId',
                        headerName: 'Status',
                        sortable: true,
                        filter: true,
                        valueGetter: function (params) {
                            const status = $scope.statuses.find(s => s.id === parseInt(params.data.statusId));
                            return status ? status.StatusName : '';
                        }
                    },
                    { field: 'messageDate', headerName: 'Message Date', sortable: true, filter: true }
                ],
                defaultColDef: {
                    flex: 1,
                    minWidth: 150,
                    resizable: true
                },
                domLayout: 'normal',
                rowData: $scope.loans,
                onGridReady: function (params) {
                    $scope.gridApi = params.api;
                    params.api.sizeColumnsToFit();
                }
            };

            $scope.updateUserType = function () {
                $scope.userType = $scope.isOffshore ? 'offshore' : 'onshore';
                $scope.selectedLoan = null;
                $scope.searchLoans(); // This will handle both onshore and offshore cases
            };

            // Add refresh function
            $scope.refreshResults = function () {
                $scope.selectedQueue = [];
                $scope.selectedCategory = null;
                $scope.selectedStatus = null;
                $scope.startDate = null;
                $scope.endDate = null;
                $scope.restrictionMessage = ''; // Clear any restriction messages

                // Get all messages (no need to filter by user type as we only get offshore data)
                let results = $scope.messages;

                // Apply brand filter if a brand is selected
                if ($scope.selectedBrand) {
                    results = results.filter(message => message.brandId === $scope.selectedBrand.id);
                }

                // Maintain default sort order
                results.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));
                $scope.searchResults = results;
            };
            // Update searchLoans function to handle all user stories
            $scope.searchLoans = function () {
                // Clear previous restriction message
                $scope.restrictionMessage = '';

                // Check if loans data is available
                if (!$scope.loans || $scope.loans.length === 0) {
                    console.log("Loans data not yet loaded, deferring search");
                    $scope.searchResults = [];
                    return;
                }

                // First, apply all filters to get the initial result set
                let results = $scope.messages.filter(message => {
                    const loan = $scope.loans.find(l => l.id === message.loanId);
                    if (!loan) return false;

                    // Apply all search filters
                    const loanMatch = !$scope.loanNumber ||
                        (loan.loanNumber && loan.loanNumber.toString().toLowerCase().includes(($scope.loanNumber || '').toLowerCase()));

                    const queueMatch = !$scope.selectedQueue || !$scope.selectedQueue.length ||
                        (message.queueId && $scope.selectedQueue.includes(message.queueId.toString()));

                    const categoryMatch = !$scope.selectedCategory ||
                        (message.categoryId && message.categoryId.toString() === $scope.selectedCategory);

                    const firstNameMatch = !$scope.firstName ||
                        (loan.borrowerName && loan.borrowerName.toLowerCase().includes(($scope.firstName || '').toLowerCase()));

                    const lastNameMatch = !$scope.lastName ||
                        (loan.borrowerName && loan.borrowerName.toLowerCase().includes(($scope.lastName || '').toLowerCase()));

                    const statusMatch = !$scope.selectedStatus ||
                        (message.statusId && message.statusId.toString() === $scope.selectedStatus);

                    const deletedMatch = $scope.showDeleted === undefined ||
                        message.isDeleted === ($scope.showDeleted === 'true');

                    // Apply brand filter if a brand is selected
                    const brandMatch = !$scope.selectedBrand ||
                        (message.brandId && message.brandId === $scope.selectedBrand.id);

                    const dateMatch = (!$scope.startDate || new Date(message.messageDate) >= new Date($scope.startDate)) &&
                        (!$scope.endDate || new Date(message.messageDate) <= new Date($scope.endDate));

                    return loanMatch && queueMatch && categoryMatch && firstNameMatch && lastNameMatch &&
                        statusMatch && deletedMatch && brandMatch && dateMatch;
                });

                // User Story 1: If search by loan number results in exactly one restricted record
                // Show "Loan is not provisioned to the user" message
                if ($scope.loanNumber && results.length === 1) {
                    const loan = $scope.loans.find(l => l.id === results[0].loanId);
                    const brand = $scope.brands.find(b => b.id === results[0].brandId);

                    // Check if the loan or brand is restricted
                    if ((loan && loan.restricted) || (brand && brand.restricted)) {
                        $scope.restrictionMessage = "Loan is not provisioned to the user";
                        $scope.searchResults = [];
                        return;
                    }
                }

                // Sort results by date (maintaining default sort order)
                results.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));
                $scope.searchResults = results;
            };
        });
    </script>
</body>

</html>