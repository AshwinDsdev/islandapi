<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoanSphere Messages</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- AngularJS and Angular Material -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.2.5/angular-material.min.js"></script>
    <link href="https://ajax.googleapis.com/ajax/libs/angular_material/1.2.5/angular-material.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-aria.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular-animate.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --text-light: #ecf0f1;
            --background-color: #f5f6fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            color: var(--primary-color);
        }

        .wrapper {
            min-height: 100vh;
            background-color: white;
            box-shadow: var(--box-shadow);
        }

        .header2 {
            background-color: var(--primary-color);
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            color: var(--text-light);
        }

        .menu-hamburger {
            display: flex;
            align-items: center;
        }

        .hamburger-menu {
            color: var(--text-light);
            font-size: 1.5rem;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .hamburger-menu:hover {
            color: var(--accent-color);
        }

        .header-main-1 {
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
        }

        .header-parts-client {
            color: var(--text-light);
        }

        .institution-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-light);
        }

        .content-wrapper {
            padding: 2rem;
            background-color: var(--background-color);
        }

        .searchgrid {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }

        .form-select,
        .form-control {
            display: block;
            width: 100%;
            height: 40px;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
            background-color: #fff;
            border: 1px solid #ced4da;
            border-radius: var(--border-radius);
            margin: 8px 0;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-select:focus,
        .form-control:focus {
            border-color: var(--accent-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .info-section {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            margin-bottom: 20px;
        }

        .material-icons {
            color: var(--accent-color);
            transition: transform 0.2s ease;
            font-size: 22px;
        }

        .material-icons:hover {
            transform: scale(1.1);
            color: #2980b9;
        }

        .ag-theme-material {
            --ag-header-height: 56px;
            --ag-header-background-color: #f8f9fa;
            --ag-header-foreground-color: var(--primary-color);
            --ag-header-cell-hover-background-color: #edf2f7;
            --ag-row-hover-color: #f1f5f9;
        }

        .ag-header-cell {
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .ag-header-cell-text {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 14px;
        }

        .ag-row:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                padding: 1rem;
            }

            .searchgrid {
                padding: 1rem;
            }
        }

        .form-switch .form-check-input {
            width: 3em;
            cursor: pointer;
        }

        .form-switch .form-check-input:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        .form-check-label {
            cursor: pointer;
        }
    </style>
    <!-- Add these in the head section after existing CSS links -->
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-material.css">
</head>

<body ng-app="loanApp" ng-controller="LoanController">
    <div id="loading-indicator" style="padding: 40px; display: none;">
        Loading...
    </div>
    <div class="wrapper">
        <header class="header2 d-flex flex-column flex-md-row align-items-center px-3 py-2">
            <div class="menu-hamburger">
                <i class="fas fa-bars hamburger-menu"></i>
                <span
                    style="color: whitesmoke; font-family: 'Suisse-SemiBold'; font-size: 1.5em; padding: 1px 0px 0px 24px;">
                    One Admin
                </span>
            </div>
            <div class="header-main-1 header-main-new ms-auto">
                <div class="header-parts-client py-2">
                    <div class="institution-name ng-star-inserted">Cenlar FSB</div>

                    <div class="form-group">
                        <select class="form-select" ng-model="selectedLoan">
                            <option value="" disabled>Select Loan</option>
                            <option ng-repeat="loan in getAccessibleLoans()" value="{{loan.id}}">
                                {{loan.loanNumber}} - {{loan.propertyInfo}}
                            </option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-select" ng-model="selectedChannel">
                            <option ng-repeat="channel in channels" value="{{channel.id}}">{{channel.name}}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <select class="form-select" ng-model="selectedBrand">
                            <option ng-repeat="brand in getAccessibleBrands()" ng-value="brand">{{brand.name}}</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>
        <main class="content-wrapper">
            <div class="container searchgrid">
                <div class="alert alert-warning" ng-if="restrictionMessage">
                    {{ restrictionMessage }}
                </div>
                <div class="info-section">
                    <i class="material-icons">info_outline</i>
                    <span class="info-text">How header filtering works</span>
                </div>
                <form novalidate="" name="form" autocomplete="off" class="ng-untouched ng-pristine ng-valid">
                    <div class="flex-row-container flex-wrap">
                        <div class="form-group">
                            <label>Queue</label>
                            <select class="form-select" ng-model="selectedQueue" multiple
                                aria-describedby="cdk-describedby-message-ng-1-10">
                                <option ng-repeat="queue in queues" value="{{queue.id}}">{{queue.name}}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Category</label>
                            <select class="form-select" ng-model="selectedCategory"
                                aria-describedby="cdk-describedby-message-ng-1-11">
                                <option value="" disabled>Select Category</option>
                                <option ng-repeat="category in categories" value="{{category.id}}">
                                    {{category.CategoryName}}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" class="form-control" ng-model="firstName" placeholder="Enter First Name"
                                aria-describedby="cdk-describedby-message-ng-1-12">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" class="form-control" ng-model="lastName" placeholder="Enter Last Name"
                                aria-describedby="cdk-describedby-message-ng-1-13">
                        </div>
                        <div class="form-group">
                            <label>Loan Number</label>
                            <input type="text" class="form-control" ng-model="loanNumber"
                                placeholder="Enter Loan Number" aria-describedby="cdk-describedby-message-ng-1-14">
                        </div>
                        <div class="form-group">
                            <label>Show Deleted</label>
                            <select class="form-select" ng-model="showDeleted"
                                aria-describedby="cdk-describedby-message-ng-1-16">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" class="form-control" ng-model="startDate"
                                aria-describedby="cdk-describedby-message-ng-1-17">
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" class="form-control" ng-model="endDate"
                                aria-describedby="cdk-describedby-message-ng-1-18">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" ng-click="searchLoans()">
                                <i class="fas fa-search"></i> Search
                            </button>
                            <button class="btn btn-secondary ms-2" ng-click="refreshResults()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                            <button class="btn btn-info ms-2" ng-click="returnToMessages()">
                                <i class="fas fa-arrow-left"></i> Return to Messages
                            </button>
                        </div>
                        <div class="form-group">
                            <div class="d-flex align-items-end">
                                <div class="flex-grow-1 me-2">
                                    <label>Select Loan to Remove</label>
                                    <select class="form-select" ng-model="loanToRemove">
                                        <option value="" disabled selected>Choose loan to remove...</option>
                                        <option ng-repeat="loan in getAccessibleLoans()"
                                                ng-if="canRemoveLoan(loan.id)"
                                                value="{{loan.id}}">
                                            {{loan.loanNumber}} - {{loan.propertyInfo}}
                                        </option>
                                    </select>
                                </div>
                                <button class="btn btn-danger"
                                        ng-click="removeLoan(loanToRemove)"
                                        ng-disabled="!loanToRemove">
                                    <i class="fas fa-trash-alt"></i> Remove Loan
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="container searchgrid">
                <div class="info-section">
                    <i class="material-icons">info_outline</i>
                    <span class="info-text">How column sorting and filtering works</span>
                </div>
                <mat-card appearance="outlined"
                    class="mat-mdc-card mdc-card p-0 mat-mdc-card-outlined mdc-card--outlined">
                    <!-- Replace the ag-grid div with this table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Message Date</th>
                                    <th>Sender</th>
                                    <th>Message</th>
                                    <th>Queue</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Loan Number</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-repeat="message in searchResults">
                                    <td>{{message.messageDate}}</td>
                                    <td>{{message.sender}}</td>
                                    <td>{{message.messageText}}</td>
                                    <td>{{getQueueName(message.queueId)}}</td>
                                    <td>{{getCategoryName(message.categoryId)}}</td>
                                    <td>{{getStatusName(message.statusId)}}</td>
                                    <td>{{getLoanNumber(message.loanId)}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </mat-card>
            </div>
        </main>
    </div>

    <div class="cdk-live-announcer-element cdk-visually-hidden" aria-atomic="true" aria-live="polite"
        id="cdk-live-announcer-0"></div>
    <div class="cdk-overlay-container"></div>
    <div class="cdk-describedby-message-container cdk-visually-hidden" style="visibility: hidden;">
        <div id="cdk-describedby-message-ng-1-8" role="tooltip">Help Center</div>
        <div id="cdk-describedby-message-ng-1-9" role="tooltip">User Profile Menu</div>
        <div id="cdk-describedby-message-ng-1-10" role="tooltip">Show Message Threads in selected Queue(s)</div>
        <div id="cdk-describedby-message-ng-1-11" role="tooltip">Show Message Threads in selected Category</div>
        <div id="cdk-describedby-message-ng-1-12" role="tooltip">Show Message Threads from Borrower(s) with specified
            First Name</div>
        <div id="cdk-describedby-message-ng-1-13" role="tooltip">Show Message Threads from Borrower(s) with specified
            Last Name</div>
        <div id="cdk-describedby-message-ng-1-14" role="tooltip">Show Message Threads from Borrower(s) with specified
            Loan Number</div>
        <div id="cdk-describedby-message-ng-1-15" role="tooltip">Show Message Threads with selected Status</div>
        <div id="cdk-describedby-message-ng-1-16" role="tooltip">Show Message Threads that Borrowers have Deleted</div>
        <div id="cdk-describedby-message-ng-1-17" role="tooltip">Show Message Threads with Borrower Message Date on or
            after selected date</div>
        <div id="cdk-describedby-message-ng-1-18" role="tooltip">Show Message Threads with Borrower Message Date on or
            before selected date</div>
        <div id="cdk-describedby-message-ng-1-19" role="tooltip">Filtering applies to all message threads and search
            results are sorted by Borrower Message Date.</div>
        <div id="cdk-describedby-message-ng-1-20" role="tooltip">Sorting/filtering applies only to the current search
            results page.</div>
    </div>

    <!-- Bootstrap and AngularJS Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"></script>
    <script src="Brand_Ingestion.js" type="module"></script>
    <script src="Loan_Ingestion.js" type="module"></script>
    <script src="Message_Ingestion.js" type="module"></script>
    <script src="Queue_Ingestion.js" type="module"></script>

    <script>
        /**
         * LoanSphere Messages Management Module
         *
         * This module handles the message search, display, and management functionality.
         * It provides features for searching, filtering, and displaying message data
         * with proper handling of restricted loans and brands.
         */
        var app = angular.module('loanApp', ['ngMaterial', 'ngAria', 'ngAnimate']);

        /**
         * Data Loading Service
         * Handles loading data from external sources with proper error handling and timeouts
         */
        app.service('DataService', function() {
            /**
             * Wait for data to be available in the global scope with timeout
             * @param {string} dataKey - The key to check in the window object
             * @param {string} dataName - Human-readable name for logging
             * @param {Array} fallbackData - Data to use if loading fails
             * @param {number} maxAttempts - Maximum number of attempts before using fallback
             * @returns {Promise<Array>} The loaded data or fallback
             */
            this.waitForData = async function(dataKey, dataName, fallbackData = [], maxAttempts = 5) {
                let attempts = 0;

                while (!window[dataKey] && attempts < maxAttempts) {
                    console.log(`Waiting for ${dataName} data... Attempt ${attempts + 1}/${maxAttempts}`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                }

                if (!window[dataKey]) {
                    console.warn(`Timed out waiting for ${dataName} data, using fallback data`);
                    return fallbackData;
                }

                console.log(`${dataName} data loaded successfully`);
                return window[dataKey];
            };

            /**
             * Load loans data
             * @returns {Promise<Array>} Loans data
             */
            this.loadLoans = function() {
                return this.waitForData('storedLoansSet', 'loans', []);
            };

            /**
             * Load messages data
             * @returns {Promise<Array>} Messages data
             */
            this.loadMessages = function() {
                return this.waitForData('storedMessagesSet', 'messages', []);
            };

            /**
             * Load brands data
             * @returns {Promise<Array>} Brands data
             */
            this.loadBrands = function() {
                const fallbackBrands = [
                    {
                        id: 5,
                        name: "Bank of America",
                        value: "bankofamerica",
                        type: "offshore",
                        restricted: false
                    },
                    {
                        id: 6,
                        name: "Citibank",
                        value: "citibank",
                        type: "offshore",
                        restricted: false
                    }
                ];
                return this.waitForData('storedNumbersSet', 'brands', fallbackBrands);
            };
        });

        /**
         * Message Filter Service
         * Provides functions for filtering messages based on various criteria
         */
        app.service('MessageFilterService', function() {
            /**
             * Check if a loan is accessible to an offshore user
             * @param {Object} loan - The loan to check
             * @returns {boolean} True if the loan is accessible
             */
            this.isLoanAccessible = function(loan) {
                return loan && !loan.restricted;
            };

            /**
             * Check if a message is accessible to an offshore user
             * @param {Object} message - The message to check
             * @param {Array} loans - All loans
             * @param {Array} brands - All brands
             * @returns {boolean} True if the message is accessible
             */
            this.isMessageAccessible = function(message, loans, brands) {
                if (!message) return false;

                // Get the associated loan and brand
                const loan = loans.find(l => l.id === message.loanId);
                const brand = brands.find(b => b.id === message.brandId);

                // Message is accessible if both loan and brand are not restricted
                return this.isLoanAccessible(loan) && (!brand || !brand.restricted);
            };

            /**
             * Get accessible loans for offshore users
             * @param {Array} loans - All loans
             * @returns {Array} Accessible loans
             */
            this.getAccessibleLoans = function(loans) {
                return loans.filter(loan => this.isLoanAccessible(loan));
            };

            /**
             * Get accessible brands for offshore users
             * @param {Array} brands - All brands
             * @returns {Array} Accessible brands
             */
            this.getAccessibleBrands = function(brands) {
                return brands.filter(brand => !brand.restricted);
            };

            /**
             * Check if a queue should be visible to the current user
             * @param {Object} queue - The queue to check
             * @returns {boolean} True if the queue is visible
             */
            this.isQueueVisibleToUser = function(queue) {
                if (queue.hasOwnProperty('restricted')) {
                    return !queue.restricted;
                }
                return true;
            };

            /**
             * Check if a message matches all search criteria
             * @param {Object} message - The message to check
             * @param {Array} loans - All loans
             * @param {Object} criteria - Search criteria
             * @returns {boolean} True if the message matches all criteria
             */
            this.messageMatchesSearchCriteria = function(message, loans, criteria) {
                const loan = loans.find(l => l.id === message.loanId);
                if (!loan) return false;

                // Apply all search filters
                const loanMatch = !criteria.loanNumber ||
                    (loan.loanNumber && loan.loanNumber.toString().toLowerCase().includes((criteria.loanNumber || '').toLowerCase()));

                const queueMatch = !criteria.selectedQueue || !criteria.selectedQueue.length ||
                    (message.queueId && criteria.selectedQueue.includes(message.queueId.toString()));

                const categoryMatch = !criteria.selectedCategory ||
                    (message.categoryId && message.categoryId.toString() === criteria.selectedCategory);

                const firstNameMatch = !criteria.firstName ||
                    (loan.borrowerName && loan.borrowerName.toLowerCase().includes((criteria.firstName || '').toLowerCase()));

                const lastNameMatch = !criteria.lastName ||
                    (loan.borrowerName && loan.borrowerName.toLowerCase().includes((criteria.lastName || '').toLowerCase()));

                const statusMatch = !criteria.selectedStatus ||
                    (message.statusId && message.statusId.toString() === criteria.selectedStatus);

                const deletedMatch = criteria.showDeleted === undefined ||
                    message.isDeleted === (criteria.showDeleted === 'true');

                // Apply brand filter if a brand is selected
                const brandMatch = !criteria.selectedBrand ||
                    (message.brandId && message.brandId === criteria.selectedBrand.id);

                const dateMatch = (!criteria.startDate || new Date(message.messageDate) >= new Date(criteria.startDate)) &&
                    (!criteria.endDate || new Date(message.messageDate) <= new Date(criteria.endDate));

                return loanMatch && queueMatch && categoryMatch && firstNameMatch && lastNameMatch &&
                    statusMatch && deletedMatch && brandMatch && dateMatch;
            };

            /**
             * Filter queues based on type and visibility
             * @param {Array} queues - All queues
             * @param {string} filter - Filter type ('all', 'my', 'team')
             * @param {Object} selectedBrand - Selected brand
             * @returns {Array} Filtered queues
             */
            this.filterQueues = function(queues, filter, selectedBrand) {
                // First filter by queue type
                let filteredQueues = queues;
                if (filter !== 'all') {
                    filteredQueues = queues.filter(queue => queue.type === filter);
                }

                // Then filter by visibility
                filteredQueues = filteredQueues.filter(queue => this.isQueueVisibleToUser(queue));

                // Then filter by selected brand if any
                if (selectedBrand) {
                    filteredQueues = filteredQueues.filter(queue =>
                        queue.brandIds && queue.brandIds.includes(selectedBrand.id)
                    );
                }

                // Sort by the original sort order
                return filteredQueues.sort((a, b) => a.sortOrder - b.sortOrder);
            };
        });

        /**
         * Main Controller for the LoanSphere Messages application
         */
        app.controller('LoanController', function($scope, $timeout, DataService, MessageFilterService) {
            // Initialize state
            $scope.loans = [];
            $scope.messages = [];
            $scope.brands = [];
            $scope.searchResults = [];
            $scope.restrictionMessage = '';
            $scope.userType = 'offshore'; // All users are treated as offshore users

            // Initialize UI state
            $scope.selectedQueue = [];
            $scope.selectedCategory = null;
            $scope.selectedStatus = null;
            $scope.startDate = null;
            $scope.endDate = null;
            $scope.firstName = '';
            $scope.lastName = '';
            $scope.loanNumber = '';
            $scope.showDeleted = undefined;
            $scope.selectedLoan = null;
            $scope.loanToRemove = null;
            $scope.activeFilter = 'all';
            $scope.filteredQueues = [];

            // Define static data
            $scope.queues = [
                {
                    id: 1,
                    name: "Default Queue",
                    type: "my",
                    sortOrder: 1,
                    brandIds: [1, 2, 3],
                    restricted: false,
                    items: []
                },
                {
                    id: 2,
                    name: "High Priority",
                    type: "my",
                    sortOrder: 2,
                    brandIds: [2, 3],
                    restricted: false,
                    items: []
                },
                {
                    id: 3,
                    name: "Customer Service",
                    type: "team",
                    sortOrder: 3,
                    brandIds: [1, 4],
                    restricted: false,
                    items: []
                },
                {
                    id: 4,
                    name: "Technical Support",
                    type: "team",
                    sortOrder: 4,
                    brandIds: [3, 4, 5],
                    restricted: false,
                    items: []
                },
                {
                    id: 5,
                    name: "Loan Processing",
                    type: "my",
                    sortOrder: 5,
                    brandIds: [1, 5],
                    restricted: false,
                    items: []
                },
                {
                    id: 6,
                    name: "Underwriting",
                    type: "team",
                    sortOrder: 6,
                    brandIds: [2, 5, 6],
                    restricted: false,
                    items: []
                },
                {
                    id: 7,
                    name: "Restricted Queue",
                    type: "my",
                    sortOrder: 7,
                    brandIds: [7, 8],
                    restricted: true,
                    items: []
                },
                {
                    id: 8,
                    name: "Unrestricted Specific",
                    type: "my",
                    sortOrder: 8,
                    brandIds: [5, 6, 7, 8],
                    restricted: false,
                    items: []
                }
            ];

            $scope.categories = [
                { id: 1, CategoryName: "General Inquiry" },
                { id: 2, CategoryName: "Payment Issues" },
                { id: 3, CategoryName: "Loan Application" },
                { id: 4, CategoryName: "Technical Support" }
            ];

            $scope.channels = [
                { id: 1, name: "Borrower Self-Service" },
                { id: 2, name: "Customer Portal" },
                { id: 3, name: "Mobile App" }
            ];

            $scope.statuses = [
                { id: 1, StatusName: "Active" },
                { id: 2, StatusName: "Pending" },
                { id: 3, StatusName: "Completed" },
                { id: 4, StatusName: "On Hold" }
            ];

            // Grid options for ag-grid
            $scope.gridOptions = {
                columnDefs: [
                    { field: 'loanNumber', headerName: 'Loan Number', sortable: true, filter: true },
                    { field: 'borrowerName', headerName: 'Borrower Name', sortable: true, filter: true },
                    { field: 'propertyInfo', headerName: 'Property Info', sortable: true, filter: true },
                    {
                        field: 'queueId',
                        headerName: 'Queue',
                        sortable: true,
                        filter: true,
                        valueGetter: function (params) {
                            const queue = $scope.queues.find(q => q.id === parseInt(params.data.queueId));
                            return queue ? queue.Value : '';
                        }
                    },
                    {
                        field: 'categoryId',
                        headerName: 'Category',
                        sortable: true,
                        filter: true,
                        valueGetter: function (params) {
                            const category = $scope.categories.find(c => c.id === parseInt(params.data.categoryId));
                            return category ? category.CategoryName : '';
                        }
                    },
                    {
                        field: 'statusId',
                        headerName: 'Status',
                        sortable: true,
                        filter: true,
                        valueGetter: function (params) {
                            const status = $scope.statuses.find(s => s.id === parseInt(params.data.statusId));
                            return status ? status.StatusName : '';
                        }
                    },
                    { field: 'messageDate', headerName: 'Message Date', sortable: true, filter: true }
                ],
                defaultColDef: {
                    flex: 1,
                    minWidth: 150,
                    resizable: true
                },
                domLayout: 'normal',
                rowData: $scope.loans,
                onGridReady: function (params) {
                    $scope.gridApi = params.api;
                    params.api.sizeColumnsToFit();
                }
            };

            /**
             * Initialize the application by loading data
             */
            function initialize() {
                // Load all data in parallel
                Promise.all([
                    DataService.loadLoans(),
                    DataService.loadMessages(),
                    DataService.loadBrands()
                ]).then(([loansData, messagesData, brandsData]) => {
                    // Process and store the data
                    $scope.loans = loansData || [];
                    $scope.messages = messagesData || [];

                    // Process brand data
                    $scope.brands = brandsData.map(brand => ({
                        id: brand.id,
                        name: brand.name,
                        value: brand.value,
                        type: brand.type,
                        restricted: brand.restricted
                    }));

                    // Set default brand and apply initial filtering
                    $timeout(function() {
                        if ($scope.brands && $scope.brands.length > 0) {
                            $scope.selectedBrand = $scope.brands[0];
                            $scope.selectedChannel = $scope.channels[0];
                            $scope.setFilter('all');
                            $scope.refreshResults();
                        }
                    });
                }).catch(error => {
                    console.error("Error initializing application:", error);
                });
            }

            // Initialize the application
            initialize();

            // ===== Helper Functions =====

            /**
             * Get the name of a queue by ID
             * @param {number} queueId - The queue ID
             * @returns {string} The queue name
             */
            $scope.getQueueName = function(queueId) {
                const queue = $scope.queues.find(q => q.id === parseInt(queueId));
                return queue ? queue.name : '';
            };

            /**
             * Get the name of a category by ID
             * @param {number} categoryId - The category ID
             * @returns {string} The category name
             */
            $scope.getCategoryName = function(categoryId) {
                const category = $scope.categories.find(c => c.id === parseInt(categoryId));
                return category ? category.CategoryName : '';
            };

            /**
             * Get the name of a status by ID
             * @param {number} statusId - The status ID
             * @returns {string} The status name
             */
            $scope.getStatusName = function(statusId) {
                const status = $scope.statuses.find(s => s.id === parseInt(statusId));
                return status ? status.StatusName : '';
            };

            /**
             * Get the loan number by loan ID
             * @param {number} loanId - The loan ID
             * @returns {string} The loan number
             */
            $scope.getLoanNumber = function(loanId) {
                const loan = $scope.loans.find(l => l.id === loanId);
                return loan ? loan.loanNumber : '';
            };

            // ===== Delegate to MessageFilterService =====

            /**
             * Check if a loan is accessible to an offshore user
             * @param {Object} loan - The loan to check
             * @returns {boolean} True if the loan is accessible
             */
            $scope.isLoanAccessible = function(loan) {
                return MessageFilterService.isLoanAccessible(loan);
            };

            /**
             * Check if a message is accessible to an offshore user
             * @param {Object} message - The message to check
             * @returns {boolean} True if the message is accessible
             */
            $scope.isMessageAccessible = function(message) {
                return MessageFilterService.isMessageAccessible(message, $scope.loans, $scope.brands);
            };

            /**
             * Get accessible loans for offshore users
             * @returns {Array} Accessible loans
             */
            $scope.getAccessibleLoans = function() {
                return MessageFilterService.getAccessibleLoans($scope.loans);
            };

            /**
             * Get accessible brands for offshore users
             * @returns {Array} Accessible brands
             */
            $scope.getAccessibleBrands = function() {
                return MessageFilterService.getAccessibleBrands($scope.brands);
            };

            /**
             * Check if a queue should be visible to the current user
             * @param {Object} queue - The queue to check
             * @returns {boolean} True if the queue is visible
             */
            $scope.isQueueVisibleToUser = function(queue) {
                return MessageFilterService.isQueueVisibleToUser(queue);
            };

            /**
             * Check if a message matches all search criteria
             * @param {Object} message - The message to check
             * @returns {boolean} True if the message matches all criteria
             */
            $scope.messageMatchesSearchCriteria = function(message) {
                const criteria = {
                    loanNumber: $scope.loanNumber,
                    selectedQueue: $scope.selectedQueue,
                    selectedCategory: $scope.selectedCategory,
                    firstName: $scope.firstName,
                    lastName: $scope.lastName,
                    selectedStatus: $scope.selectedStatus,
                    showDeleted: $scope.showDeleted,
                    selectedBrand: $scope.selectedBrand,
                    startDate: $scope.startDate,
                    endDate: $scope.endDate
                };
                return MessageFilterService.messageMatchesSearchCriteria(message, $scope.loans, criteria);
            };

            /**
             * Check if a loan can be removed
             * @param {number} loanId - The loan ID
             * @returns {boolean} True if the loan can be removed
             */
            $scope.canRemoveLoan = function(loanId) {
                const loan = $scope.loans.find(l => l.id === loanId);
                return $scope.isLoanAccessible(loan);
            };

            // ===== Action Functions =====

            /**
             * Set active filter for queues
             * @param {string} filter - Filter type ('all', 'my', 'team')
             */
            $scope.setFilter = function(filter) {
                $scope.activeFilter = filter;
                $scope.filteredQueues = MessageFilterService.filterQueues(
                    $scope.queues,
                    filter,
                    $scope.selectedBrand
                );
            };

            /**
             * Remove a loan
             * @param {number} loanId - The loan ID to remove
             */
            $scope.removeLoan = function(loanId) {
                if (!loanId) return;

                // Find the loan in the loans array
                const loanIndex = $scope.loans.findIndex(l => l.id.toString() === loanId.toString());
                if (loanIndex === -1) return;

                // Remove the loan from the array
                $scope.loans.splice(loanIndex, 1);

                // Reset the loanToRemove property
                $scope.loanToRemove = null;

                // Update the search results
                $scope.searchLoans();
            };

            /**
             * Return to messages list
             * Resets filters and shows only accessible messages
             */
            $scope.returnToMessages = function() {
                // Reset filters
                $scope.selectedQueue = [];
                $scope.selectedCategory = null;
                $scope.selectedStatus = null;
                $scope.startDate = null;
                $scope.endDate = null;
                $scope.firstName = '';
                $scope.lastName = '';
                $scope.loanNumber = '';
                $scope.showDeleted = undefined;
                $scope.selectedLoan = null;
                $scope.restrictionMessage = '';

                // Filter out messages that are not accessible to offshore users
                let accessibleMessages = $scope.messages.filter(message =>
                    $scope.isMessageAccessible(message)
                );

                // Apply brand filter if a brand is selected
                if ($scope.selectedBrand) {
                    accessibleMessages = accessibleMessages.filter(message =>
                        message.brandId === $scope.selectedBrand.id
                    );
                }

                // Sort by date (maintaining default sort order)
                accessibleMessages.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));

                $scope.searchResults = accessibleMessages;
            };

            /**
             * Refresh results
             * Resets filters and shows only accessible messages
             */
            $scope.refreshResults = function() {
                // Reset search filters but keep brand selection
                $scope.selectedQueue = [];
                $scope.selectedCategory = null;
                $scope.selectedStatus = null;
                $scope.startDate = null;
                $scope.endDate = null;
                $scope.firstName = '';
                $scope.lastName = '';
                $scope.loanNumber = '';
                $scope.showDeleted = undefined;
                $scope.restrictionMessage = '';

                // Filter out messages that are not accessible to offshore users
                let accessibleMessages = $scope.messages.filter(message =>
                    $scope.isMessageAccessible(message)
                );

                // Apply brand filter if a brand is selected
                if ($scope.selectedBrand) {
                    accessibleMessages = accessibleMessages.filter(message =>
                        message.brandId === $scope.selectedBrand.id
                    );
                }

                // Maintain default sort order
                accessibleMessages.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));
                $scope.searchResults = accessibleMessages;
            };

            /**
             * Search loans based on criteria
             * Implements all user stories for search functionality
             */
            $scope.searchLoans = function() {
                // Clear previous restriction message
                $scope.restrictionMessage = '';

                // Check if loans data is available
                if (!$scope.loans || $scope.loans.length === 0) {
                    console.log("Loans data not yet loaded, deferring search");
                    $scope.searchResults = [];
                    return;
                }

                // Step 1: Get all messages that match the search criteria
                let filteredMessages = $scope.messages.filter(message =>
                    $scope.messageMatchesSearchCriteria(message)
                );

                // Step 2: Handle User Story 1 - If search by loan number results in exactly one record
                // that is restricted, show "Loan is not provisioned to the user" message
                if ($scope.loanNumber && filteredMessages.length === 1) {
                    const message = filteredMessages[0];
                    const loan = $scope.loans.find(l => l.id === message.loanId);
                    const brand = $scope.brands.find(b => b.id === message.brandId);

                    // Check if the loan or brand is restricted
                    if ((loan && loan.restricted) || (brand && brand.restricted)) {
                        $scope.restrictionMessage = "Loan is not provisioned to the user";
                        $scope.searchResults = [];
                        return;
                    }
                }

                // Step 3: Filter out messages that are not accessible to offshore users
                let accessibleMessages = filteredMessages.filter(message =>
                    $scope.isMessageAccessible(message)
                );

                // Step 4: Sort results by date (maintaining default sort order)
                accessibleMessages.sort((a, b) => new Date(b.messageDate) - new Date(a.messageDate));

                $scope.searchResults = accessibleMessages;
            };
        });
    </script>
</body>

</html>